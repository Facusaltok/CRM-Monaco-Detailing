<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monaco Detailing CRM — Dashboard</title>
<link rel="manifest" href="./manifest.webmanifest" />
<meta name="theme-color" content="#0a8d4b" />
<style>
  :root{--bg:#0a0a0a;--panel:#101317;--border:#1f2937;--text:#e8eef2;--mut:#9fb0bf;--accent:#0a8d4b;--accent2:#19c37d}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,rgba(10,141,75,.05),transparent 25%),var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:20;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(16,19,23,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800}
  .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 0 14px rgba(25,195,125,.7)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:#0f141a;color:var(--text);padding:.55rem .8rem;border-radius:10px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#07150f;border-color:transparent;font-weight:800}
  nav{display:flex;gap:6px;padding:10px 12px;border-bottom:1px solid var(--border);background:#0d1116}
  .tabbtn{border:1px solid var(--border);background:#101317;color:var(--text);padding:.55rem .8rem;border-radius:10px;cursor:pointer}
  .tabbtn.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0a120c;border-color:transparent;font-weight:800}
  .container{max-width:1200px;margin:14px auto;padding:0 12px 24px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
  .card h2{margin:.2rem 0 .6rem;font-size:1.05rem;color:var(--accent)}
  canvas,svg{width:100%;height:260px;display:block}
  /* KPIs */
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
  .kpi{background:linear-gradient(180deg,rgba(25,195,125,.10),rgba(25,195,125,.02));border:1px solid rgba(25,195,125,.35);border-radius:12px;padding:12px}
  .kpi b{font-size:22px;display:block;margin-top:4px}
  /* Agenda semanal */
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 12px}
  .field{display:flex;align-items:center;gap:6px;background:#0f141a;border:1px solid var(--border);border-radius:10px;padding:6px 8px;color:var(--mut)}
  .field input{background:transparent;border:0;color:var(--text);outline:none}
  .week{display:grid;grid-template-columns:80px repeat(7,1fr);gap:6px}
  .hours{display:grid;grid-template-rows:repeat(24,36px);gap:6px}
  .daycol{display:grid;grid-template-rows:repeat(24,36px);gap:6px;position:relative}
  .slot{border:1px dashed rgba(255,255,255,.06);border-radius:8px}
  .event{position:relative;margin:2px;border:1px solid rgba(25,195,125,.45);background:linear-gradient(90deg,var(--accent),var(--accent2));color:#07150f;font-weight:800;font-size:12px;border-radius:8px;padding:6px 8px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .legend{display:flex;gap:8px;flex-wrap:wrap;color:var(--mut);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="brand"><div class="dot"></div><div>MONACO DETAILING — CRM</div></div>
  <div class="actions">
    <button id="btnExport" class="btn">Exportar JSON</button>
    <button id="btnSignOut" class="btn">Salir</button>
  </div>
</header>

<nav>
  <button class="tabbtn active" data-tab="dash">Dashboard</button>
  <button class="tabbtn" data-tab="agenda">Agenda</button>
  <button class="tabbtn" data-tab="mkt">Marketing</button>
</nav>

<div class="container">

  <!-- DASHBOARD -->
  <section id="tab-dash" class="tab" style="display:block">
    <div class="kpis">
      <div class="kpi"><small>Ingresos del mes</small><b id="kpi-revenue">$0</b></div>
      <div class="kpi"><small>Citas hoy</small><b id="kpi-appointments">0</b></div>
      <div class="kpi"><small>Nuevos clientes</small><b id="kpi-clients">0</b></div>
      <div class="kpi"><small>Retención</small><b id="kpi-retention">0%</b></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="card"><h2>Embudo de conversión</h2><svg id="funnel"></svg></div>
      <div class="card"><h2>Fuentes de leads</h2><canvas id="chartLeads"></canvas></div>
      <div class="card"><h2>Servicios (ranking)</h2><canvas id="chartServices"></canvas></div>
      <div class="card"><h2>Actividad (mapa de calor)</h2><canvas id="chartHeatmap"></canvas></div>
    </div>
  </section>

  <!-- AGENDA -->
  <section id="tab-agenda" class="tab" style="display:none">
    <div class="card">
      <h2>Agenda semanal</h2>
      <div class="toolbar">
        <button class="btn" id="btnPrev">◀︎ Semana</button>
        <button class="btn" id="btnToday">Hoy</button>
        <button class="btn" id="btnNext">Semana ▶︎</button>
        <div class="field">
          <span>Calendar ID</span>
          <input id="gcalId" placeholder="tu-cal@group.calendar.google.com" style="min-width:280px"/>
        </div>
        <button class="btn primary" id="btnSync">Actualizar con Google Calendar</button>
        <div class="legend" id="rangeLabel"></div>
      </div>

      <div class="week" id="weekGrid">
        <div class="hours" id="hours"></div>
        <div class="daycol" data-day="1"></div>
        <div class="daycol" data-day="2"></div>
        <div class="daycol" data-day="3"></div>
        <div class="daycol" data-day="4"></div>
        <div class="daycol" data-day="5"></div>
        <div class="daycol" data-day="6"></div>
        <div class="daycol" data-day="7"></div>
      </div>
    </div>
  </section>

  <!-- MARKETING -->
  <section id="tab-mkt" class="tab" style="display:none">
    <div class="grid">
      <div class="card"><h2>Conversiones por campaña</h2><canvas id="chartCampaigns"></canvas></div>
      <div class="card"><h2>Eventos recientes</h2><div id="mktLogs" style="display:grid;gap:8px;max-height:260px;overflow:auto"></div></div>
    </div>
  </section>

</div>

<script type="module">
  import { supabase } from "./supabaseClient.js";
  import "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";

  // Proteger ruta
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) location.href = "./index.html";
  supabase.auth.onAuthStateChange((_e, s)=>{ if(!s) location.href="./index.html"; });
  document.getElementById("btnSignOut").onclick = async ()=> { await supabase.auth.signOut(); };

  // Tabs
  document.querySelectorAll('.tabbtn').forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(x=>x.style.display='none');
      b.classList.add('active'); document.getElementById('tab-'+b.dataset.tab).style.display='block';
      if(b.dataset.tab==='agenda') renderWeek(); // asegura alturas
    }
  });

  // KPIs demo
  const data = {
    kpis:{ revenue:1200000, appointments:5, clients:3, retention:85 },
    leadSources:{ Instagram:40, Publicidad:25, Web:20, WhatsApp:15 },
    services:{ 'Interior':72, 'Tratamiento Cerámico':48, 'Motor a Vapor':34, 'Paquete Completo':28 },
    campaigns:{ 'IG Agosto':120, 'Ads Display':80, 'Referidos':95, 'SEO Local':60 }
  };
  const fmt = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n);
  document.getElementById('kpi-revenue').textContent = fmt(data.kpis.revenue);
  document.getElementById('kpi-appointments').textContent = data.kpis.appointments;
  document.getElementById('kpi-clients').textContent = data.kpis.clients;
  document.getElementById('kpi-retention').textContent = data.kpis.retention + '%';

  // Charts
  new Chart(document.getElementById('chartLeads'), {
    type:'doughnut',
    data:{ labels:Object.keys(data.leadSources), datasets:[{ data:Object.values(data.leadSources), backgroundColor:['#0a8d4b','#1f2937','#465','#789']}] },
    options:{ responsive:true, maintainAspectRatio:false }
  });
  new Chart(document.getElementById('chartServices'), {
    type:'bar',
    data:{ labels:Object.keys(data.services), datasets:[{ label:'Servicios', data:Object.values(data.services), backgroundColor:'#0a8d4b'}]},
    options:{ responsive:true, maintainAspectRatio:false }
  });
  new Chart(document.getElementById('chartCampaigns'), {
    type:'bar',
    data:{ labels:Object.keys(data.campaigns), datasets:[{ label:'Conversiones', data:Object.values(data.campaigns), backgroundColor:'#0a8d4b'}]},
    options:{ responsive:true, maintainAspectRatio:false }
  });

  // Heatmap simple
  (function heat(){
    const c=document.getElementById('chartHeatmap'); if(!c) return; const ctx=c.getContext('2d');
    const w=c.width=c.clientWidth, h=c.height=c.clientHeight, cols=7, rows=10, cw=w/cols, rh=h/rows;
    const val=Array.from({length:rows},()=>Array.from({length:cols},()=>Math.random()));
    for(let r=0;r<rows;r++) for(let col=0;col<cols;col++){
      const t=val[r][col], g=ctx.createLinearGradient(0,r*rh,0,r*rh+rh);
      const base=.15 + t*.65; g.addColorStop(0,`rgba(10,141,75,${base})`); g.addColorStop(1,`rgba(10,141,75,${Math.max(0,base-.1)})`);
      ctx.fillStyle=g; ctx.fillRect(col*cw+2,r*rh+2,cw-4,rh-4);
    }
    ctx.strokeStyle='rgba(255,255,255,.08)';
    for(let x=0;x<=cols;x++){ctx.beginPath();ctx.moveTo(x*cw,0);ctx.lineTo(x*cw,h);ctx.stroke()}
    for(let y=0;y<=rows;y++){ctx.beginPath();ctx.moveTo(0,y*rh);ctx.lineTo(w,y*rh);ctx.stroke()}
  })();

  // Funnel SVG
  (function funnel(){
    const f=document.getElementById('funnel'); const w=f.clientWidth||300, h=260; f.setAttribute('viewBox',`0 0 ${w} ${h}`);
    const rows=[[w*1.0,70,'Visitas'],[w*.75,70,'Oportunidades'],[w*.5,70,'Clientes']]; let y=10;
    rows.forEach(([bw,bh,label],i)=>{ const x=(w-bw)/2;
      const p=document.createElementNS('http://www.w3.org/2000/svg','rect'); p.setAttribute('x',x); p.setAttribute('y',y); p.setAttribute('rx','10'); p.setAttribute('width',bw); p.setAttribute('height',bh);
      p.setAttribute('fill', i? (i===1?'#1f2937':'#495') : '#0a8d4b'); f.appendChild(p);
      const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',w/2); t.setAttribute('y',y+bh/2+5); t.setAttribute('text-anchor','middle'); t.setAttribute('fill','#e8eef2'); t.textContent=label; f.appendChild(t);
      y+=bh+12;
    });
  })();

  // ====== AGENDA (Google Calendar) ======
  // Estado de semana
  const hoursCol = document.getElementById('hours');
  const dayCols  = Array.from(document.querySelectorAll('.daycol'));
  for(let i=0;i<24;i++){ const d=document.createElement('div'); d.style.fontSize='11px'; d.style.opacity='.6'; d.textContent=(8+i<=9?'0':'')+(8+i)+':00'; hoursCol.appendChild(d); }
  function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()||7); x.setDate(x.getDate()-day+1); x.setHours(0,0,0,0); return x; } // lunes
  let weekStart = startOfWeek(new Date());
  const label = document.getElementById('rangeLabel');
  const gcalInput = document.getElementById('gcalId');
  gcalInput.value = localStorage.getItem('gcal_id') || '';

  document.getElementById('btnPrev').onclick = ()=>{ weekStart.setDate(weekStart.getDate()-7); renderWeek(); };
  document.getElementById('btnNext').onclick = ()=>{ weekStart.setDate(weekStart.getDate()+7); renderWeek(); };
  document.getElementById('btnToday').onclick= ()=>{ weekStart = startOfWeek(new Date()); renderWeek(); };
  document.getElementById('btnSync').onclick = ()=>{ localStorage.setItem('gcal_id', gcalInput.value.trim()); syncCalendar(); };

  function renderWeek(){
    // encabezado/limpieza
    label.textContent = weekStart.toLocaleDateString('es-AR',{day:'2-digit',month:'short'}) + ' — ' +
      new Date(weekStart.getTime()+6*864e5).toLocaleDateString('es-AR',{day:'2-digit',month:'short'});
    dayCols.forEach(col=>{ col.innerHTML=''; for(let r=0;r<24;r++){ const s=document.createElement('div'); s.className='slot'; col.appendChild(s); }});
  }

  function eventToPlacement(ev){
    const start = new Date(ev.start.dateTime || ev.start.date);
    const end   = new Date(ev.end?.dateTime || ev.end?.date || start.getTime()+60*60*1000);
    const dow = (start.getDay()||7); // 1..7
    const minutesFrom8 = (start.getHours()-8)*60 + start.getMinutes();
    const duration = Math.max(30, (end-start)/60000);
    const rowStart = Math.max(1, Math.floor(minutesFrom8/30)+1);
    const rowSpan  = Math.max(1, Math.ceil(duration/30));
    return { dow, rowStart, rowSpan, title: ev.summary||'Evento', start };
  }

  async function syncCalendar(){
    const calendarId = (gcalInput.value || '').trim();
    if(!calendarId){ alert('Ingresá un Calendar ID público.'); return; }
    try{
      const timeMin = new Date(weekStart).toISOString();
      const timeMax = new Date(weekStart.getTime()+7*864e5).toISOString();
      const url = `/api/calendar?calendarId=${encodeURIComponent(calendarId)}&timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}`;
      const res = await fetch(url);
      const json = await res.json();
      renderWeek();
      (json.items||[]).forEach(ev=>{
        const p = eventToPlacement(ev);
        const col = dayCols[p.dow-1];
        if(!col) return;
        const e = document.createElement('div'); e.className='event';
        e.style.gridRow = `${p.rowStart} / span ${p.rowSpan}`;
        e.textContent = `${p.title} (${p.start.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'})})`;
        col.appendChild(e);
      });
    }catch(err){ console.warn(err); alert('No se pudo sincronizar el calendario. Verificá el Calendar ID y las variables en Vercel.'); }
  }

  renderWeek(); // primer render
  // puedes llamar syncCalendar() si querés auto-cargar: // syncCalendar();

  // Export demo
  document.getElementById('btnExport').onclick = ()=>{
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='monaco_crm_demo.json'; a.click(); URL.revokeObjectURL(url);
  };
</script>
</body>
</html>
