<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monaco Detailing CRM ‚Äî Dashboard</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='64' fill='%230a8d4b'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' dominant-baseline='middle' font-size='62' fill='white' font-family='Arial' %3EM%3C/text%3E%3C/svg%3E">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{ brand:"#0a8d4b", brand2:"#19c37d", border:"#e5e7eb", textmut:"#5b677a" },
          boxShadow:{ card:"0 12px 24px rgba(20,30,40,.06)" }
        }
      }
    }
  </script>

  <!-- Alpine -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    window.sb = supabase.createClient(
      "https://nqokfvddbpjqrsfflntk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xb2tmdmRkYnBqcXJzZmZsbnRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NDE5OTgsImV4cCI6MjA3MTIxNzk5OH0.A5CzSNjHJ9y012vJjDunzYMTzoxGwu6RV88OmKYOUGo"
    );
  </script>

  <style>
    body{ background:#f6f8fb; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 12px 24px rgba(20,30,40,.06) }
    .btn{ border:1px solid #d9e1ea; background:#fff; color:#0b1220; font-weight:700; border-radius:12px; padding:.6rem .9rem; box-shadow:0 6px 0 #e3e8ef, 0 14px 24px rgba(10,20,30,.08), inset 0 1px 0 rgba(255,255,255,.7); transition:all .15s }
    .btn:hover{ background:#f7fafc }
    .btn-primary{ background:linear-gradient(90deg,#0a8d4b,#19c37d); color:#062015; border-color:#16a86a }
    .input, select, textarea{ border:1px solid #d1d5db; border-radius:.7rem; padding:.6rem .8rem; width:100% }
    .input:focus, select:focus, textarea:focus{ outline:none; border-color:#19c37d; box-shadow:0 0 0 3px rgba(25,195,125,.2) }
    .pill{ display:inline-flex; align-items:center; border-radius:999px; padding:.2rem .55rem; font-size:.75rem; font-weight:700 }
    [x-cloak]{ display:none !important }
  </style>
</head>

<body x-data="crm()" x-init="init()">

  <!-- Topbar -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-border">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-3.5 h-3.5 rounded-full" style="background:linear-gradient(90deg,#0a8d4b,#19c37d)"></div>
        <h1 class="font-extrabold tracking-wide">MONACO DETAILING ‚Äî CRM</h1>
      </div>
      <div class="flex gap-2">
        <button class="btn" @click="onRefresh()">‚ü≥ Actualizar</button>
        <button class="btn" @click="logout()">Salir</button>
      </div>
    </div>
  </header>

  <!-- Nav -->
  <nav class="bg-white border-b border-border">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap gap-2">
      <button class="btn" :class="{'btn-primary':tab==='home'}" @click="tab='home'">Dashboard</button>
      <button class="btn" :class="{'btn-primary':tab==='clientes'}" @click="tab='clientes'">Clientes</button>
      <button class="btn" :class="{'btn-primary':tab==='vehiculos'}" @click="tab='vehiculos'">Veh√≠culos</button>
      <button class="btn" :class="{'btn-primary':tab==='citas'}" @click="tab='citas'">Citas</button>
      <!-- ‚ùóÔ∏èAntes ac√° se llamaba renderCharts() fuera de scope y romp√≠a el JS -->
      <button class="btn" :class="{'btn-primary':tab==='reporte'}" @click="tab='reporte'">Reportes</button>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Efecto seguro para renderizar charts cuando tab === 'reporte' -->
    <div x-effect="if(tab==='reporte'){ $nextTick(()=>{ renderCharts() }) }"></div>

    <!-- DASHBOARD -->
    <section x-show="tab==='home'" x-cloak>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-emerald-100 text-brand flex items-center justify-center">üë•</div>
          <div><div class="text-sm text-textmut">Clientes</div><div class="text-2xl font-extrabold" x-text="stats.clientes"></div></div>
        </div>
        <div class="card p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-emerald-100 text-brand flex items-center justify-center">üóìÔ∏è</div>
          <div><div class="text-sm text-textmut">Citas hoy</div><div class="text-2xl font-extrabold" x-text="stats.citasHoy"></div></div>
        </div>
        <div class="card p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-emerald-100 text-brand flex items-center justify-center">$</div>
          <div><div class="text-sm text-textmut">Ingresos hoy</div><div class="text-2xl font-extrabold" x-text="fmtARS(stats.ingresosHoy)"></div></div>
        </div>
        <div class="card p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-emerald-100 text-brand flex items-center justify-center">üöó</div>
          <div><div class="text-sm text-textmut">Veh√≠culos</div><div class="text-2xl font-extrabold" x-text="stats.vehiculos"></div></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
        <div class="card p-5">
          <h2 class="font-bold text-brand mb-3">Agenda ‚Äî Google Calendar</h2>
          <div class="aspect-[4/3] w-full border border-border rounded-xl overflow-hidden bg-white">
            <iframe class="w-full h-full" frameborder="0" scrolling="no"
              src="https://calendar.google.com/calendar/embed?src=monacodetailingarg%40gmail.com&ctz=America%2FArgentina%2FBuenos_Aires"></iframe>
          </div>
          <p class="text-sm text-textmut mt-2">Vista del calendario (solo lectura).</p>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-bold text-brand">Citas del d√≠a</h2>
            <button class="btn" @click="openCita()">+ Nueva cita</button>
          </div>
          <ul class="divide-y">
            <template x-for="a in citasHoy()" :key="a.id">
              <li class="py-3 flex items-center justify-between">
                <div>
                  <div class="font-semibold" x-text="a.cliente_nombre || 'Cliente'"></div>
                  <div class="text-sm text-textmut" x-text="a.servicio + ' ‚Äî ' + fmtARS(a.precio || 0)"></div>
                </div>
                <div class="flex items-center gap-2">
                  <span class="pill" :class="statusPill(a.estado)" x-text="a.estado"></span>
                  <button class="btn" @click="openCita(a)">Editar</button>
                </div>
              </li>
            </template>
            <li x-show="citas.length===0" class="text-center py-6 text-textmut">Sin citas cargadas</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section x-show="tab==='clientes'" x-cloak>
      <div class="card p-5">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
          <h2 class="font-bold text-brand text-lg">Clientes</h2>
          <div class="flex gap-2 w-full md:w-auto">
            <input class="input w-full md:w-72" placeholder="Buscar‚Ä¶" x-model="filtros.clientQ">
            <button class="btn btn-primary" @click="openCliente()">+ Nuevo cliente</button>
          </div>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b">
                <th class="py-2 px-3">Nombre</th>
                <th class="py-2 px-3">Email</th>
                <th class="py-2 px-3">Tel√©fono</th>
                <th class="py-2 px-3">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="c in clientesFiltrados()" :key="c.id">
                <tr class="border-b hover:bg-slate-50">
                  <td class="py-2 px-3" x-text="c.nombre"></td>
                  <td class="py-2 px-3" x-text="c.email || '‚Äî'"></td>
                  <td class="py-2 px-3" x-text="c.telefono || '‚Äî'"></td>
                  <td class="py-2 px-3">
                    <button class="btn" @click="openCliente(c)">Editar</button>
                    <button class="btn" @click="delCliente(c.id)">Eliminar</button>
                  </td>
                </tr>
              </template>
              <tr x-show="clientes.length===0"><td colspan="4" class="py-6 text-center text-textmut">Sin clientes</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- VEH√çCULOS -->
    <section x-show="tab==='vehiculos'" x-cloak>
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="font-bold text-brand text-lg">Veh√≠culos</h2>
          <button class="btn btn-primary" @click="openVehiculo()">+ Nuevo veh√≠culo</button>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b">
                <th class="py-2 px-3">Cliente</th>
                <th class="py-2 px-3">Marca/Modelo</th>
                <th class="py-2 px-3">Patente</th>
                <th class="py-2 px-3">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="v in vehiculosRender()" :key="v.id">
                <tr class="border-b hover:bg-slate-50">
                  <td class="py-2 px-3" x-text="v.cliente_nombre || '‚Äî'"></td>
                  <td class="py-2 px-3" x-text="(v.marca||'') + ' ' + (v.modelo||'')"></td>
                  <td class="py-2 px-3" x-text="v.dominio || '‚Äî'"></td>
                  <td class="py-2 px-3">
                    <button class="btn" @click="openVehiculo(v)">Editar</button>
                    <button class="btn" @click="delVehiculo(v.id)">Eliminar</button>
                  </td>
                </tr>
              </template>
              <tr x-show="vehiculos.length===0"><td colspan="4" class="py-6 text-center text-textmut">Sin veh√≠culos</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CITAS -->
    <section x-show="tab==='citas'" x-cloak>
      <div class="card p-5">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
          <h2 class="font-bold text-brand text-lg">Citas</h2>
          <div class="flex gap-2 w-full md:w-auto">
            <input class="input w-44" type="date" x-model="filtros.citaFecha">
            <select class="input w-44" x-model="filtros.citaEstado">
              <option value="">Todos</option>
              <option value="pendiente">Pendiente</option>
              <option value="completado">Completado</option>
              <option value="cancelado">Cancelado</option>
            </select>
            <button class="btn btn-primary" @click="openCita()">+ Nueva cita</button>
          </div>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b">
                <th class="py-2 px-3">Cliente</th>
                <th class="py-2 px-3">Servicio(s)</th>
                <th class="py-2 px-3">Veh√≠culo</th>
                <th class="py-2 px-3">Fecha/Hora</th>
                <th class="py-2 px-3">Precio</th>
                <th class="py-2 px-3">Estado</th>
                <th class="py-2 px-3">Acciones</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="a in citasRender()" :key="a.id">
                <tr class="border-b hover:bg-slate-50">
                  <td class="py-2 px-3" x-text="a.cliente_nombre"></td>
                  <td class="py-2 px-3" x-text="a.servicio"></td>
                  <td class="py-2 px-3" x-text="a.vehiculo_desc || '‚Äî'"></td>
                  <td class="py-2 px-3" x-text="fmtDateTime(a.fecha)"></td>
                  <td class="py-2 px-3" x-text="fmtARS(a.precio || 0)"></td>
                  <td class="py-2 px-3"><span class="pill" :class="statusPill(a.estado)" x-text="a.estado"></span></td>
                  <td class="py-2 px-3">
                    <button class="btn" @click="openCita(a)">Editar</button>
                    <button class="btn" @click="delCita(a.id)">Eliminar</button>
                  </td>
                </tr>
              </template>
              <tr x-show="citas.length===0"><td colspan="7" class="py-6 text-center text-textmut">Sin citas</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPORTE -->
    <section x-show="tab==='reporte'" x-cloak>
      <div class="card p-5">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
          <div>
            <label class="text-sm block mb-1">Desde</label>
            <input class="input" type="date" x-model="reportFilter.from">
          </div>
          <div>
            <label class="text-sm block mb-1">Hasta</label>
            <input class="input" type="date" x-model="reportFilter.to">
          </div>
          <div class="md:col-span-2">
            <button class="btn btn-primary w-full" @click="applyReportFilter()">Aplicar filtro</button>
          </div>
          <div class="flex gap-2">
            <button class="btn w-full" @click="exportCSV()">Exportar CSV</button>
            <button class="btn w-full" @click="exportPDF()">Exportar PDF</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div class="card p-5 text-center">
          <h3 class="text-lg font-semibold opacity-80">Ingresos</h3>
          <div class="text-3xl font-extrabold mt-1 text-brand" x-text="fmtARS(report.ingresos)"></div>
          <div class="text-xs opacity-70">Periodo filtrado</div>
        </div>
        <div class="card p-5 text-center">
          <h3 class="text-lg font-semibold opacity-80">Clientes</h3>
          <div class="text-3xl font-extrabold mt-1" x-text="report.clientes"></div>
          <div class="text-xs opacity-70">Nuevos en el periodo</div>
        </div>
        <div class="card p-5 text-center">
          <h3 class="text-lg font-semibold opacity-80">Ganancia total</h3>
          <div class="text-3xl font-extrabold mt-1 text-amber-500" x-text="fmtARS(report.ganancia)"></div>
          <div class="text-xs opacity-70">Ingresos - 30% costos</div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
        <div class="card p-5">
          <h4 class="font-semibold text-center mb-3">Ingresos por Servicio</h4>
          <canvas id="chServicios" height="240"></canvas>
        </div>
        <div class="card p-5">
          <h4 class="font-semibold text-center mb-3">Ingresos Mensuales</h4>
          <canvas id="chIngresos" height="240"></canvas>
        </div>
        <div class="card p-5">
          <h4 class="font-semibold text-center mb-3">Clientes por Mes</h4>
          <canvas id="chClientes" height="240"></canvas>
        </div>
      </div>
    </section>

  </main>

  <!-- MODAL CLIENTE -->
  <div x-show="modal.cliente" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" x-transition.opacity>
    <div class="card w-full max-w-lg p-5">
      <h3 class="font-bold text-brand mb-3" x-text="clienteForm.id ? 'Editar cliente' : 'Nuevo cliente'"></h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input class="input" placeholder="Nombre" x-model="clienteForm.nombre">
        <input class="input" placeholder="Email" x-model="clienteForm.email" type="email">
        <input class="input" placeholder="Tel√©fono" x-model="clienteForm.telefono">
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button class="btn" @click="modal.cliente=false">Cancelar</button>
        <button class="btn btn-primary" @click="saveCliente()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL CITA (segmento + multiselecci√≥n) -->
  <div x-show="modal.cita" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" x-transition.opacity>
    <div class="card w-full max-w-2xl p-5">
      <h3 class="font-bold text-brand mb-3" x-text="citaForm.id ? 'Editar cita' : 'Nueva cita'"></h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-sm block mb-1">Cliente</label>
          <select class="input" x-model="citaForm.cliente_id" @change="onClienteChange()">
            <option value="">Cliente‚Ä¶</option>
            <template x-for="c in clientes" :key="c.id">
              <option :value="c.id" x-text="c.nombre"></option>
            </template>
          </select>
        </div>

        <div>
          <label class="text-sm block mb-1">Veh√≠culo</label>
          <select class="input" x-model="citaForm.vehiculo_id">
            <option value="">Seleccion√°‚Ä¶</option>
            <template x-for="v in vehiculosDeCliente()" :key="v.id">
              <option :value="v.id" x-text="vehiculoLabel(v)"></option>
            </template>
          </select>
        </div>

        <div>
          <label class="text-sm block mb-1">Fecha y hora</label>
          <input class="input" type="datetime-local" x-model="citaForm.fecha">
        </div>

        <div>
          <label class="text-sm block mb-1">Estado</label>
          <select class="input" x-model="citaForm.estado">
            <option value="pendiente">Pendiente</option>
            <option value="completado">Completado</option>
            <option value="cancelado">Cancelado</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm block mb-1">Notas</label>
          <textarea class="input" rows="3" placeholder="Observaciones‚Ä¶" x-model="citaForm.notas"></textarea>
        </div>
      </div>

      <!-- Segmento + Men√∫ desplegable multiselecci√≥n -->
      <div class="mt-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-start">
          <div>
            <label class="text-sm block mb-1">Segmento</label>
            <select class="input" x-model="serviceTab">
              <option value="autos">Autos (Hatch / Sedan)</option>
              <option value="suv">SUV / Pick-Up</option>
              <option value="motos">Motos</option>
              <option value="tratamientos">Tratamientos</option>
            </select>
          </div>

          <div class="relative" @click.outside="showSrvDD=false">
            <label class="text-sm block mb-1">Servicios</label>
            <button type="button" class="input text-left flex items-center justify-between"
                    @click="showSrvDD=!showSrvDD">
              <span class="truncate" x-text="citaForm.selectedServices.length ? citaForm.selectedServices.map(s=>s.name).join(' + ') : 'Eleg√≠ uno o m√°s servicios'"></span>
              <span>‚ñæ</span>
            </button>

            <div x-show="showSrvDD" x-transition class="absolute z-50 mt-1 w-full card p-3 max-h-72 overflow-auto">
              <template x-for="opt in currentServiceOptions()" :key="opt.key">
                <label class="flex items-start gap-2 py-1 cursor-pointer">
                  <input type="checkbox" class="mt-1" :checked="isSelected(opt.nameLabel)"
                         @change="toggleService({ name: opt.nameLabel, price: num(opt.price) })">
                  <div>
                    <div class="text-sm font-medium" x-text="opt.nameLabel + ' ‚Äî ' + fmtARS(num(opt.price))"></div>
                  </div>
                </label>
              </template>

              <div class="border-t mt-2 pt-2 flex items-center justify-between">
                <div class="text-sm text-textmut">Total parcial</div>
                <div class="text-sm font-bold" x-text="fmtARS(citaForm.total)"></div>
              </div>

              <div class="mt-2 text-right">
                <button class="btn btn-primary" @click="showSrvDD=false">Listo</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4 flex items-center justify-between border-t pt-3">
        <div class="text-sm text-textmut">
          Seleccionados: <span class="font-semibold" x-text="citaForm.selectedServices.map(s=>s.name).join(' + ') || '‚Äî'"></span>
        </div>
        <div class="text-lg font-extrabold">Total: <span x-text="fmtARS(citaForm.total)"></span></div>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button class="btn" @click="modal.cita=false">Cancelar</button>
        <button class="btn btn-primary" @click="saveCita()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL VEH√çCULO -->
  <div x-show="modal.vehiculo" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" x-transition.opacity>
    <div class="card w-full max-w-lg p-5">
      <h3 class="font-bold text-brand mb-3" x-text="vehiculoForm.id ? 'Editar veh√≠culo' : 'Nuevo veh√≠culo'"></h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <select class="input" x-model="vehiculoForm.cliente_id">
          <option value="">Cliente‚Ä¶</option>
          <template x-for="c in clientes" :key="c.id">
            <option :value="c.id" x-text="c.nombre"></option>
          </template>
        </select>
        <input class="input" placeholder="Marca" x-model="vehiculoForm.marca">
        <input class="input" placeholder="Modelo" x-model="vehiculoForm.modelo">
        <input class="input" placeholder="Patente" x-model="vehiculoForm.dominio">
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button class="btn" @click="modal.vehiculo=false">Cancelar</button>
        <button class="btn btn-primary" @click="saveVehiculo()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- L√ìGICA -->
  <script>
    const sb = window.sb;

    window.crm = function(){
      return {
        tab:'home',
        userId:null,

        clientes:[], vehiculos:[], citas:[],
        modal:{ cliente:false, cita:false, vehiculo:false },

        clienteForm:{ id:null, nombre:'', email:'', telefono:'' },
        vehiculoForm:{ id:null, cliente_id:'', marca:'', modelo:'', dominio:'' },

        citaForm:{
          id:null,
          cliente_id:'', vehiculo_id:'',
          servicio:'', selectedServices:[],
          fecha:'', precio:'', total:0,
          estado:'pendiente', notas:''
        },

        filtros:{ clientQ:'', citaFecha:'', citaEstado:'' },
        stats:{ clientes:0, citasHoy:0, ingresosHoy:0, vehiculos:0 },

        report:{ ingresos:0, ganancia:0, clientes:0 },
        reportFilter:{ from:'', to:'' },
        _charts:{ servicios:null, ingresos:null, clientes:null },

        showSrvDD:false,
        serviceTab:'autos',

        // Cat√°logos
        serviceCatalog:{
          autos: [
            { name: "Interior (Hatch / Sedan)", desc:"Aspirado profundo, descontaminaci√≥n del habit√°culo y reacondicionamiento de pl√°sticos.", price:150000, time:"1 d√≠a" },
            { name: "Interior al Detalle (Hatch / Sedan)", desc:"Desarme, aspirado profundo, limpieza de techo y tapizados, descontaminaci√≥n y reacondicionamiento de pl√°sticos.", price:250000, time:"2-3 d√≠as" },
            { name: "Motor a Vapor (Hatch / Sedan)", desc:"Limpieza t√©cnica del vano motor a vapor.", price:100000, time:"En el d√≠a" },
            { name: "Paquete Completo (Hatch / Sedan)", desc:"Abrillantado + Interior + Motor a Vapor.", price:350000, time:"2‚Äì3 d√≠as" }
          ],
          suv: [
            { name: "Interior (SUV / Pick-Up)", desc:"Aspirado profundo, descontaminaci√≥n del habit√°culo y reacondicionamiento de pl√°sticos.", price:200000, time:"1 d√≠a" },
            { name: "Interior al Detalle (SUV / Pick-Up)", desc:"Desarme, aspirado profundo, limpieza de techo y tapizados, descontaminaci√≥n y reacondicionamiento de pl√°sticos.", price:300000, time:"2-3 d√≠as" },
            { name: "Motor a Vapor (SUV / Pick-Up)", desc:"Limpieza t√©cnica del vano motor a vapor.", price:130000, time:"En el d√≠a" },
            { name: "Paquete Completo SUV / Pick-Up", desc:"Abrillantado + Interior + Motor a Vapor.", price:450000, time:"2‚Äì3 d√≠as" }
          ],
          motos: [
            { name:"Tratamiento Motos", desc:"Lavado + descontaminaci√≥n + reacondicionamiento de pl√°sticos + lubricaci√≥n de cadena + protecci√≥n (Acr√≠lico o Cer√°mico).", price:200000, time:"En el d√≠a" }
          ]
        },
        tratamientos:[
          { grupo:"Autos (Hatch / Sedan)", items:[
              { name:"Acr√≠lico", detalle:"Duraci√≥n 6 meses", price:300000 },
              { name:"Cer√°mico", detalle:"Duraci√≥n 1 a√±o", price:400000 },
              { name:"Cer√°mico c/Grafeno", detalle:"Duraci√≥n 2 a√±os", price:500000 }
            ]},
          { grupo:"Pick-Up / SUV", items:[
              { name:"Acr√≠lico", detalle:"Duraci√≥n 6 meses", price:400000 },
              { name:"Cer√°mico", detalle:"Duraci√≥n 1 a√±o", price:500000 },
              { name:"Cer√°mico c/Grafeno", detalle:"Duraci√≥n 2 a√±os", price:600000 }
            ]}
        ],

        // Helpers
        num(v){ return typeof v==='number' ? v : (parseInt(String(v).replace(/[^0-9]/g,''))||0) },
        fmtARS(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(+n||0) },
        fmtDateTime(iso){ if(!iso) return ''; const d=new Date(iso); return d.toLocaleString('es-AR',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}); },
        statusPill(s){ return { 'bg-emerald-100 text-emerald-700': s==='completado','bg-yellow-100 text-yellow-700': s==='pendiente','bg-red-100 text-red-700': s==='cancelado' } },
        vehiculoLabel(v){ return `${v.marca||''} ${v.modelo||''} ${v.dominio?('('+v.dominio+')'):''}`.trim() || 'Veh√≠culo'; },

        // Init / Refresh
        async init(){
          const { data:{ session } } = await sb.auth.getSession();
          if(!session){ location.href='./index.html'; return; }
          this.userId = session.user.id;
          await this.loadAll();
        },
        async onRefresh(){
          await this.loadAll();
          if (this.tab === 'reporte') this.$nextTick(()=>this.renderCharts());
        },
        async loadAll(){ await Promise.all([this.loadClientes(), this.loadVehiculos(), this.loadCitas()]); this.recalc(); this.buildReport(); },

        async logout(){ await sb.auth.signOut(); location.href='./index.html'; },

        // CLIENTES
        async loadClientes(){
          const { data, error } = await sb.from('clientes')
            .select('id,nombre,email,telefono,created_at,creado_en')
            .order('id',{ascending:false});
          if (error){ console.error('loadClientes', error); this.clientes=[]; return; }
          this.clientes = data || [];
        },
        openCliente(c){ this.clienteForm = c ? JSON.parse(JSON.stringify(c)) : { id:null, nombre:'', email:'', telefono:'' }; this.modal.cliente = true; },
        async saveCliente(){
          const row = { nombre:(this.clienteForm.nombre||'').trim(), email:(this.clienteForm.email||'').trim()||null, telefono:(this.clienteForm.telefono||'').trim()||null, user_id:this.userId };
          let error;
          if (this.clienteForm.id) ({ error } = await sb.from('clientes').update(row).eq('id', this.clienteForm.id));
          else                      ({ error } = await sb.from('clientes').insert(row));
          if (error) { alert(error.message); return; }
          this.modal.cliente=false; await this.loadClientes(); this.recalc(); this.buildReport();
        },
        async delCliente(id){ if(!confirm('¬øEliminar cliente?')) return; const { error } = await sb.from('clientes').delete().eq('id', id); if (error) alert(error.message); await this.loadClientes(); this.recalc(); this.buildReport(); },
        clientesFiltrados(){
          const q=(this.filtros.clientQ||'').toLowerCase();
          if(!q) return this.clientes;
          return this.clientes.filter(c => (c.nombre||'').toLowerCase().includes(q) || (c.email||'').toLowerCase().includes(q) || (c.telefono||'').toLowerCase().includes(q));
        },

        // VEH√çCULOS
        async loadVehiculos(){
          const { data, error } = await sb.from('vehiculos').select('id,cliente_id,marca,modelo,dominio').order('id',{ascending:false});
          if (error){ console.error('loadVehiculos', error); this.vehiculos=[]; return; }
          this.vehiculos = data || [];
        },
        vehiculosRender(){ const map = Object.fromEntries(this.clientes.map(c=>[String(c.id), c.nombre])); return this.vehiculos.map(v => ({ ...v, cliente_nombre: map[String(v.cliente_id)] || '' })); },
        vehiculosDeCliente(){ const cid = this.citaForm.cliente_id; return this.vehiculos.filter(v => String(v.cliente_id) === String(cid)); },
        openVehiculo(v){ this.vehiculoForm = v ? {id:v.id, cliente_id:v.cliente_id, marca:v.marca, modelo:v.modelo, dominio:v.dominio} : {id:null, cliente_id:'', marca:'', modelo:'', dominio:''}; this.modal.vehiculo = true; },
        async saveVehiculo(){
          const r = { cliente_id: this.vehiculoForm.cliente_id || null, marca:(this.vehiculoForm.marca||'').trim()||null, modelo:(this.vehiculoForm.modelo||'').trim()||null, dominio:(this.vehiculoForm.dominio||'').trim()||null };
          let error;
          if(this.vehiculoForm.id) ({ error } = await sb.from('vehiculos').update(r).eq('id', this.vehiculoForm.id));
          else                      ({ error } = await sb.from('vehiculos').insert(r));
          if (error) { alert(error.message); return; }
          this.modal.vehiculo=false; await this.loadVehiculos(); this.recalc(); this.buildReport();
        },
        async delVehiculo(id){ if(!confirm('¬øEliminar veh√≠culo?')) return; const { error } = await sb.from('vehiculos').delete().eq('id', id); if (error) alert(error.message); await this.loadVehiculos(); this.recalc(); this.buildReport(); },

        // CITAS
        async loadCitas(){
          const { data, error } = await sb.from('citas').select('id,cliente_id,servicio,fecha,precio,estado,notas').order('fecha',{ascending:false});
          if (error){ console.error('loadCitas', error); this.citas=[]; return; }
          this.citas = data || [];
        },
        citasRender(){
          const mapCli = Object.fromEntries(this.clientes.map(c=>[String(c.id), c.nombre]));
          return this.citas.map(a=>{
            let vehiculo_desc = null;
            const m = (a.notas||'').match(/(^|\n)Veh√≠culo:\s(.+)/i);
            if (m) vehiculo_desc = m[2]?.trim() || null;
            return { ...a, cliente_nombre: mapCli[String(a.cliente_id)] || '', vehiculo_desc };
          }).filter(a=>{
            let ok = true;
            if(this.filtros.citaFecha) ok = ok && (a.fecha||'').slice(0,10) === this.filtros.citaFecha;
            if(this.filtros.citaEstado) ok = ok && (a.estado||'') === this.filtros.citaEstado;
            return ok;
          });
        },
        onClienteChange(){ this.citaForm.vehiculo_id = ''; },
        openCita(a){
          this.citaForm = a ? {
            id:a.id, cliente_id:a.cliente_id, vehiculo_id:'', servicio:a.servicio||'',
            selectedServices:(a.servicio? a.servicio.split('+').map(n=>({name:n.trim(), price:0})) : []),
            fecha:(a.fecha||'').slice(0,16), precio:a.precio||'', total:+(a.precio||0),
            estado:a.estado||'pendiente', notas:a.notas||''
          } : {
            id:null, cliente_id:'', vehiculo_id:'', servicio:'', selectedServices:[],
            fecha:new Date().toISOString().slice(0,16), precio:'', total:0, estado:'pendiente', notas:''
          };
          this.modal.cita = true;
          this.updateTotal();
        },

        // Servicios (segmento + multiselecci√≥n)
        currentServiceOptions(){
          if (this.serviceTab==='autos') return this.serviceCatalog.autos.map((s,i)=>({ key:'a'+i, nameLabel:s.name, price:s.price }));
          if (this.serviceTab==='suv')   return this.serviceCatalog.suv.map((s,i)=>({ key:'s'+i, nameLabel:s.name, price:s.price }));
          if (this.serviceTab==='motos') return this.serviceCatalog.motos.map((s,i)=>({ key:'m'+i, nameLabel:s.name, price:s.price }));
          const out=[]; this.tratamientos.forEach((g,gi)=>g.items.forEach((it,ii)=>out.push({ key:`t${gi}-${ii}`, nameLabel:`${it.name} ‚Äî ${it.detalle}`, price:it.price })));
          return out;
        },
        isSelected(name){ return this.citaForm.selectedServices.some(s=>s.name===name); },
        toggleService(item){
          const idx = this.citaForm.selectedServices.findIndex(s=>s.name===item.name);
          if (idx>=0) this.citaForm.selectedServices.splice(idx,1);
          else this.citaForm.selectedServices.push({ name:item.name, price:this.num(item.price) });
          this.updateTotal();
        },
        updateTotal(){
          const total = this.citaForm.selectedServices.reduce((acc,s)=>acc + this.num(s.price), 0);
          this.citaForm.total = total; this.citaForm.precio = total;
        },
        async saveCita(){
          const fechaISO = this.citaForm.fecha ? new Date(this.citaForm.fecha) : null;
          const servicioStr = this.citaForm.selectedServices.map(s=>s.name).join(' + ') || (this.citaForm.servicio||'');
          let notas = (this.citaForm.notas||'').trim();
          const vehSel = this.vehiculos.find(v => String(v.id)===String(this.citaForm.vehiculo_id));
          if (vehSel){
            const vdesc = this.vehiculoLabel(vehSel);
            notas = notas.replace(/(^|\n)Veh√≠culo: .+(\n|$)/i,'$1');
            notas = (notas? (notas+'\n') : '') + `Veh√≠culo: ${vdesc}`;
          }
          const row = { cliente_id:this.citaForm.cliente_id||null, servicio:servicioStr||null, fecha:fechaISO?fechaISO.toISOString():null, precio:+this.citaForm.precio||0, estado:this.citaForm.estado, notas:notas||null, user_id:this.userId };
          let error;
          if (this.citaForm.id) ({ error } = await sb.from('citas').update(row).eq('id', this.citaForm.id));
          else                  ({ error } = await sb.from('citas').insert(row));
          if (error) { alert(error.message); return; }
          this.modal.cita=false; await this.loadCitas(); this.recalc(); this.buildReport();
        },
        async delCita(id){ if(!confirm('¬øEliminar cita?')) return; const { error } = await sb.from('citas').delete().eq('id', id); if (error) alert(error.message); await this.loadCitas(); this.recalc(); this.buildReport(); },

        // KPIs / Reporte
        recalc(){
          this.stats.clientes  = this.clientes.length;
          this.stats.vehiculos = this.vehiculos.length;
          const hoy = this.citasHoy();
          this.stats.citasHoy   = hoy.length;
          this.stats.ingresosHoy= hoy.filter(x => x.estado==='completado').reduce((a,b)=>a+(+b.precio||0),0);
        },
        citasHoy(){
          const t = new Date().toISOString().slice(0,10);
          const mapCli = Object.fromEntries(this.clientes.map(c=>[String(c.id), c.nombre]));
          return this.citas.filter(x => (x.fecha||'').slice(0,10) === t).map(a=>{
            let vehiculo_desc = null;
            const m = (a.notas||'').match(/(^|\n)Veh√≠culo:\s(.+)/i);
            if (m) vehiculo_desc = m[2]?.trim() || null;
            return { ...a, cliente_nombre: mapCli[String(a.cliente_id)] || '', vehiculo_desc };
          });
        },

        // === Reporte con filtro ===
        getReportCitas(){
          let arr = this.citas.slice();
          const from = this.reportFilter.from ? new Date(this.reportFilter.from + 'T00:00:00') : null;
          const to   = this.reportFilter.to   ? new Date(this.reportFilter.to   + 'T23:59:59') : null;
          if (from) arr = arr.filter(c => c.fecha && new Date(c.fecha) >= from);
          if (to)   arr = arr.filter(c => c.fecha && new Date(c.fecha) <= to);
          return arr;
        },
        getReportClientes(){
          let arr = this.clientes.slice();
          const from = this.reportFilter.from ? new Date(this.reportFilter.from + 'T00:00:00') : null;
          const to   = this.reportFilter.to   ? new Date(this.reportFilter.to   + 'T23:59:59') : null;
          if (from) arr = arr.filter(c => new Date(c.created_at || c.creado_en || Date.now()) >= from);
          if (to)   arr = arr.filter(c => new Date(c.created_at || c.creado_en || Date.now()) <= to);
          return arr;
        },
        applyReportFilter(){
          this.buildReport();
          this.$nextTick(()=>this.renderCharts());
        },
        buildReport(){
          const citasR = this.getReportCitas().filter(c=> (c.estado||'')==='completado');
          const totIng = citasR.reduce((a,b)=>a+(+b.precio||0),0);
          const gan = Math.round(totIng * 0.7);
          const cliR = this.getReportClientes().length;
          this.report = { ingresos: totIng, ganancia: gan, clientes: cliR };
        },

        renderCharts(){
          // destruir previos
          Object.keys(this._charts).forEach(k=>{ if(this._charts[k]){ this._charts[k].destroy(); this._charts[k]=null; }});

          const citasR = this.getReportCitas().filter(c=> (c.estado||'')==='completado');

          // Pie: ingresos por servicio
          const bySrvMap = {};
          citasR.forEach(c=>{
            const parts = (c.servicio||'').split('+').map(s=>s.trim()).filter(Boolean);
            if (!parts.length) return;
            const pr = (+c.precio||0)/parts.length;
            parts.forEach(name=>{ bySrvMap[name]=(bySrvMap[name]||0)+pr; });
          });
          const labelsSrv = Object.keys(bySrvMap);
          const dataSrv   = Object.values(bySrvMap);
          const ctxS = document.getElementById('chServicios');
          if (ctxS) this._charts.servicios = new Chart(ctxS, {
            type:'pie',
            data:{ labels:labelsSrv, datasets:[{ data:dataSrv, backgroundColor:['#0a8d4b','#059669','#10b981','#34d399','#16a34a','#22c55e','#bef264','#86efac'] }]},
            options:{ plugins:{ legend:{ position:'bottom' } } }
          });

          // L√≠nea: ingresos mensuales
          const byMonth = {};
          citasR.forEach(c=>{
            const d = new Date(c.fecha); if (isNaN(+d)) return;
            const k = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
            byMonth[k]=(byMonth[k]||0)+(+c.precio||0);
          });
          const monthsSorted = Object.keys(byMonth).sort();
          const lblMes = monthsSorted.map(k=>{ const [y,m]=k.split('-'); return new Date(+y, +m-1, 1).toLocaleString('es-AR',{month:'short'}); });
          const dataMes = monthsSorted.map(k=>byMonth[k]);
          const ctxI = document.getElementById('chIngresos');
          if (ctxI) this._charts.ingresos = new Chart(ctxI, {
            type:'line',
            data:{ labels:lblMes, datasets:[{ label:'Ingresos', data:dataMes, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,.15)', fill:true, tension:.35 }]},
            options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
          });

          // Barras: clientes por mes
          const byCliMonth = {};
          this.getReportClientes().forEach(c=>{
            const d = new Date(c.created_at || c.creado_en || Date.now());
            const k = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
            byCliMonth[k]=(byCliMonth[k]||0)+1;
          });
          const monthsCliSorted = Object.keys(byCliMonth).sort();
          const lblCli = monthsCliSorted.map(k=>{ const [y,m]=k.split('-'); return new Date(+y, +m-1, 1).toLocaleString('es-AR',{month:'short'}); });
          const dataCli = monthsCliSorted.map(k=>byCliMonth[k]);
          const ctxC = document.getElementById('chClientes');
          if (ctxC) this._charts.clientes = new Chart(ctxC, {
            type:'bar',
            data:{ labels:lblCli, datasets:[{ label:'Clientes', data:dataCli, backgroundColor:'#059669', borderRadius:6 }]},
            options:{ scales:{ y:{ beginAtZero:true } } }
          });
        },

        // EXPORTACIONES
        exportCSV(){
          const citasR = this.getReportCitas();
          const rows = [
            ['ID','Fecha','ClienteID','Servicios','Precio','Estado'],
            ...citasR.map(c=>[
              c.id, c.fecha, c.cliente_id,
              (c.servicio||'').replace(/\s*\+\s*/g,' | '),
              (+c.precio||0), c.estado||''
            ])
          ];
          const csv = rows.map(r=>r.map(v=>{
            const s=String(v??'');
            return /[",;\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s;
          }).join(',' )).join('\n');
          const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'reporte_citas.csv'; a.click();
          URL.revokeObjectURL(url);
        },
        async exportPDF(){
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ unit:'pt', format:'a4' });
          const pad = 24;

          doc.setFont('helvetica','bold'); doc.setFontSize(16);
          doc.text('Reporte ‚Äî Monaco Detailing', pad, 40);

          doc.setFont('helvetica','normal'); doc.setFontSize(10);
          const per = `Periodo: ${this.reportFilter.from||'‚Äî'} a ${this.reportFilter.to||'‚Äî'}`;
          doc.text(per, pad, 56);

          doc.setFontSize(12);
          doc.text(`Ingresos: ${this.fmtARS(this.report.ingresos)}`, pad, 78);
          doc.text(`Ganancia (70%): ${this.fmtARS(this.report.ganancia)}`, pad, 96);
          doc.text(`Clientes (nuevos): ${this.report.clientes}`, pad, 114);

          const yStart = 140;
          const canvS = document.getElementById('chServicios');
          const canvI = document.getElementById('chIngresos');
          const canvC = document.getElementById('chClientes');

          let y = yStart;
          const addChart = (canvas, title) => {
            if (!canvas) return;
            const dataURL = canvas.toDataURL('image/png', 1.0);
            doc.setFont('helvetica','bold'); doc.setFontSize(12);
            doc.text(title, pad, y);
            y += 10;
            doc.addImage(dataURL, 'PNG', pad, y, 540, 220, undefined, 'FAST');
            y += 235;
          };
          addChart(canvS, 'Ingresos por Servicio');
          if (y > 760) { doc.addPage(); y = 40; }
          addChart(canvI, 'Ingresos Mensuales');
          if (y > 760) { doc.addPage(); y = 40; }
          addChart(canvC, 'Clientes por Mes');

          doc.save('reporte.pdf');
        }
      }
    }
  </script>
</body>
</html>
