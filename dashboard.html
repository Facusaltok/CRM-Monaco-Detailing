<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monaco Detailing CRM — Dashboard</title>

  <!-- Supabase SDK GLOBAL -->
  <script src="https://unpkg.com/@supabase/supabase-js@2" crossorigin="anonymous"></script>
  <script>
    window.supabaseClient = window.supabase.createClient(
      "https://nqokfvddbpjqrsfflntk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xb2tmdmRkYnBqcXJzZmZsbnRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NDE5OTgsImV4cCI6MjA3MTIxNzk5OH0.A5CzSNjHJ9y012vJjDunzYMTzoxGwu6RV88OmKYOUGo"
    );
  </script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { brand: "#0a8d4b", brand2:"#19c37d", border:"#e5e7eb", textmut:"#5b677a" },
          boxShadow:{ card:"0 12px 24px rgba(20,30,40,.06)", btn:"0 6px 0 #e3e8ef, 0 14px 24px rgba(10,20,30,.08), inset 0 1px 0 rgba(255,255,255,.7)" },
          borderRadius:{ xl2:"14px" }
        }
      }
    }
  </script>

  <!-- Alpine -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    body{ background:#f6f8fb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 12px 24px rgba(20,30,40,.06); }
    .btn{ border:1px solid #d9e1ea; background:#fff; color:#0b1220; font-weight:700; border-radius:12px; padding:.6rem .9rem; box-shadow:0 6px 0 #e3e8ef, 0 14px 24px rgba(10,20,30,.08), inset 0 1px 0 rgba(255,255,255,.7); transition:all .15s ease; }
    .btn:hover{ background:#f7fafc }
    .btn:active{ box-shadow:0 4px 0 #e3e8ef, 0 10px 16px rgba(10,20,30,.08), inset 0 1px 0 rgba(255,255,255,.6) }
    .btn-primary{ background:linear-gradient(90deg,#0a8d4b,#19c37d); color:#062015; border-color:#16a86a; }
    .pill{ display:inline-flex; align-items:center; border-radius:999px; padding:.2rem .55rem; font-size:.75rem; font-weight:700 }
    .input, select, textarea{ border:1px solid #d1d5db; border-radius:.6rem; padding:.55rem .7rem; width:100%; }
    .input:focus, select:focus, textarea:focus{ outline:none; border-color:#19c37d; box-shadow:0 0 0 3px rgba(25,195,125,.20) }
    .table th{ color:#5b677a }
    [x-cloak]{ display:none !important }
  </style>
</head>

<body x-data="crm()" x-init="init()">
  <!-- Topbar -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-border">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-3.5 h-3.5 rounded-full" style="background:linear-gradient(90deg,#0a8d4b,#19c37d)"></div>
        <h1 class="font-extrabold tracking-wide">MONACO DETAILING — CRM</h1>
      </div>
      <div class="flex gap-2">
        <button class="btn" @click="loadAll()">⟳ Actualizar</button>
        <button class="btn" @click="logout()">Salir</button>
      </div>
    </div>
  </header>

  <!-- Nav -->
  <nav class="bg-white border-b border-border">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap gap-2">
      <button class="btn" :class="{'btn-primary':tab==='home'}" @click="tab='home'">Dashboard</button>
      <button class="btn" :class="{'btn-primary':tab==='clientes'}" @click="tab='clientes'">Clientes</button>
      <button class="btn" :class="{'btn-primary':tab==='citas'}" @click="tab='citas'">Citas</button>
      <button class="btn" :class="{'btn-primary':tab==='vehiculos'}" @click="tab='vehiculos'">Vehículos</button>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- (idéntico a tu versión – lo omití por brevedad) -->
    <!-- Pega aquí tus secciones Dashboard / Clientes / Citas / Vehículos tal como las tenías -->
  </main>

  <!-- (Tus modales) -->

  <!-- Lógica (SIN módulos) -->
  <script>
    const supabase = window.supabaseClient;

    window.crm = function(){
      return {
        tab: 'home',
        clientes: [], vehiculos: [], citas: [],
        modal: { cliente:false, cita:false, vehiculo:false },
        clienteForm: { id:null, nombre:'', email:'', telefono:'' },
        citaForm: { id:null, cliente_id:'', servicio:'', fecha:'', precio:'', estado:'pendiente', notas:'' },
        vehiculoForm: { id:null, cliente_id:'', marca:'', modelo:'', dominio:'' },
        filtros: { clientQ:'', citaFecha:'', citaEstado:'' },
        stats: { clientes:0, citasHoy:0, ingresosHoy:0, vehiculos:0 },

        fmtARS(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(+n||0) },
        fmtDateTime(iso){ if(!iso) return ''; const d=new Date(iso); return d.toLocaleString('es-AR',{weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'}); },
        statusPill(s){ return {'bg-emerald-100 text-emerald-700': s==='completado','bg-yellow-100 text-yellow-700': s==='pendiente','bg-red-100 text-red-700': s==='cancelado'}; },

        async init(){
          const { data: { session } } = await supabase.auth.getSession();
          if(!session){ location.href='./index.html'; return; }
          await this.loadAll();
        },
        async loadAll(){ await Promise.all([this.loadClientes(), this.loadVehiculos(), this.loadCitas()]); this.recalc(); },
        async logout(){ await supabase.auth.signOut(); location.href='./index.html'; },

        // Clientes
        async loadClientes(){ const { data } = await supabase.from('clientes').select('*').order('creado_en',{ascending:false}); this.clientes = data || []; },
        openCliente(c){ this.clienteForm = c ? JSON.parse(JSON.stringify(c)) : { id:null, nombre:'', email:'', telefono:'' }; this.modal.cliente = true; },
        async saveCliente(){ const r = { nombre:this.clienteForm.nombre, email:this.clienteForm.email, telefono:this.clienteForm.telefono }; if(this.clienteForm.id) await supabase.from('clientes').update(r).eq('id', this.clienteForm.id); else await supabase.from('clientes').insert(r); this.modal.cliente=false; await this.loadClientes(); this.recalc(); },
        async delCliente(id){ if(!confirm('¿Eliminar cliente?')) return; await supabase.from('clientes').delete().eq('id', id); await this.loadClientes(); this.recalc(); },
        clientesFiltrados(){ const q=(this.filtros.clientQ||'').toLowerCase(); if(!q) return this.clientes; return this.clientes.filter(c => (c.nombre||'').toLowerCase().includes(q)||(c.email||'').toLowerCase().includes(q)||(c.telefono||'').toLowerCase().includes(q)); },

        // Vehículos
        async loadVehiculos(){ const { data } = await supabase.from('vehiculos').select('*, clientes(nombre)').order('creado_en',{ascending:false}); this.vehiculos = (data||[]).map(v => ({...v, cliente_nombre: v.clientes?.nombre || ''})); },
        openVehiculo(v){ this.vehiculoForm = v ? {id:v.id, cliente_id:v.cliente_id, marca:v.marca, modelo:v.modelo, dominio:v.dominio} : {id:null, cliente_id:'', marca:'', modelo:'', dominio:''}; this.modal.vehiculo = true; },
        async saveVehiculo(){ const r = { cliente_id:this.vehiculoForm.cliente_id || null, marca:this.vehiculoForm.marca, modelo:this.vehiculoForm.modelo, dominio:this.vehiculoForm.dominio }; if(this.vehiculoForm.id) await supabase.from('vehiculos').update(r).eq('id', this.vehiculoForm.id); else await supabase.from('vehiculos').insert(r); this.modal.vehiculo=false; await this.loadVehiculos(); this.recalc(); },
        async delVehiculo(id){ if(!confirm('¿Eliminar vehículo?')) return; await supabase.from('vehiculos').delete().eq('id', id); await this.loadVehiculos(); this.recalc(); },

        // Citas
        async loadCitas(){ const { data } = await supabase.from('citas').select('*, clientes(nombre)').order('fecha',{ascending:false}); this.citas = (data||[]).map(a => ({...a, cliente_nombre: a.clientes?.nombre || ''})); },
        openCita(a){ this.citaForm = a ? { id:a.id, cliente_id:a.cliente_id, servicio:a.servicio, fecha:a.fecha?.slice(0,16), precio:a.precio||'', estado:a.estado||'pendiente', notas:a.notas||'' } : { id:null, cliente_id:'', servicio:'', fecha:new Date().toISOString().slice(0,16), precio:'', estado:'pendiente', notas:'' }; this.modal.cita = true; },
        async saveCita(){ const fechaISO = this.citaForm.fecha ? new Date(this.citaForm.fecha) : null; const r = { cliente_id:this.citaForm.cliente_id || null, servicio:this.citaForm.servicio, fecha:fechaISO ? fechaISO.toISOString() : null, precio:+this.citaForm.precio || 0, estado:this.citaForm.estado, notas:this.citaForm.notas }; if(this.citaForm.id) await supabase.from('citas').update(r).eq('id', this.citaForm.id); else await supabase.from('citas').insert(r); this.modal.cita=false; await this.loadCitas(); this.recalc(); },
        async delCita(id){ if(!confirm('¿Eliminar cita?')) return; await supabase.from('citas').delete().eq('id', id); await this.loadCitas(); this.recalc(); },
        citasFiltradas(){ let arr=this.citas.slice(); if(this.filtros.citaFecha){ const d=this.filtros.citaFecha; arr=arr.filter(x => (x.fecha||'').slice(0,10)===d); } if(this.filtros.citaEstado) arr=arr.filter(x => (x.estado||'')===this.filtros.citaEstado); return arr; },
        citasHoy(){ const t=new Date().toISOString().slice(0,10); return this.citas.filter(x => (x.fecha||'').slice(0,10)===t); },

        // KPIs
        recalc(){ this.stats.clientes=this.clientes.length; this.stats.vehiculos=this.vehiculos.length; const hoy=this.citasHoy(); this.stats.citasHoy=hoy.length; this.stats.ingresosHoy=hoy.filter(x=>x.estado==='completado').reduce((a,b)=>a+(+b.precio||0),0); }
      }
    }
  </script>
</body>
</html>
