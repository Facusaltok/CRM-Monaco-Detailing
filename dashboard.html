<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monaco Detailing CRM — Panel</title>
<link rel="manifest" href="./manifest.webmanifest" />
<meta name="theme-color" content="#0a8d4b" />
<style>
  :root{ --bg:#0a0a0a; --panel:#101317; --border:#1f2937; --text:#e8eef2; --mut:#9fb0bf; --accent:#0a8d4b; --accent2:#19c37d }
  :root[data-theme="light"]{ --bg:#f6f8fb; --panel:#ffffff; --border:#d9e1ea; --text:#0b1220; --mut:#465366 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:20;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(16,19,23,.9);border-bottom:1px solid var(--border)}
  :root[data-theme="light"] header{background:#fff}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800}
  .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 0 14px rgba(25,195,125,.7)}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:#0f141a;color:var(--text);padding:.55rem .8rem;border-radius:10px;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#07150f;border-color:transparent;font-weight:800}
  :root[data-theme="light"] .btn{background:#f7f9fc}
  nav{display:flex;gap:6px;padding:10px 12px;border-bottom:1px solid var(--border);background:transparent;flex-wrap:wrap}
  .tabbtn{border:1px solid var(--border);background:var(--panel);color:var(--text);padding:.55rem .8rem;border-radius:10px;cursor:pointer}
  .tabbtn.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0a120c;border-color:transparent;font-weight:800}
  .container{max-width:1300px;margin:14px auto;padding:0 12px 24px}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
  .card h2{margin:.2rem 0 .6rem;font-size:1.05rem;color:var(--accent)}
  .drag-handle{cursor:grab; user-select:none; opacity:.9; font-size:.9rem; color:var(--mut)}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--border);padding:.5rem;text-align:left}
  th{background:rgba(255,255,255,.04)}
  input,select,textarea{width:100%;padding:.55rem .6rem;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .mut{color:var(--mut)}
  canvas,svg{width:100%;height:260px;display:block}
  /* Agenda */
  .week{display:grid;grid-template-columns:80px repeat(7,1fr);gap:6px}
  .hours{display:grid;grid-template-rows:repeat(24,36px);gap:6px}
  .daycol{display:grid;grid-template-rows:repeat(24,36px);gap:6px;position:relative}
  .slot{border:1px dashed rgba(255,255,255,.06);border-radius:8px}
  :root[data-theme="light"] .slot{border-color:#e8edf4}
  .event{position:relative;margin:2px;border:1px solid rgba(25,195,125,.45);background:linear-gradient(90deg,var(--accent),var(--accent2));color:#07150f;font-weight:800;font-size:12px;border-radius:8px;padding:6px 8px;box-shadow:0 6px 18px rgba(0,0,0,.25);cursor:pointer}
  /* Modal */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:100%;max-width:520px;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  .modal h3{margin:.2rem 0 .6rem;color:var(--accent)}
  .row{display:grid;grid-template-columns:1fr 1fr; gap:8px}
</style>
</head>
<body>
<header>
  <div class="brand"><div class="dot"></div><div>MONACO DETAILING — CRM</div></div>
  <div class="actions">
    <button id="btnTheme" class="btn" title="Claro/Oscuro">☾/☀</button>
    <button id="btnSignOut" class="btn">Salir</button>
  </div>
</header>

<nav>
  <button class="tabbtn active" data-tab="dash">Dashboard</button>
  <button class="tabbtn" data-tab="clientes">Clientes</button>
  <button class="tabbtn" data-tab="agenda">Agenda</button>
  <button class="tabbtn" data-tab="marketing">Marketing</button>
  <button class="tabbtn" data-tab="ajustes">Ajustes</button>
</nav>

<div class="container">

  <!-- DASHBOARD -->
  <section id="tab-dash" class="tab" style="display:block">
    <div class="grid" id="dashGrid" data-grid="dash">
      <div class="card" data-id="kpis">
        <div class="drag-handle">↕ KPIs</div>
        <h2>Métricas</h2>
        <div class="grid">
          <div class="card"><div class="mut">Ingresos del mes</div><div id="kpiRevenue" style="font-size:26px;font-weight:800;margin-top:6px">$0</div></div>
          <div class="card"><div class="mut">Citas hoy</div><div id="kpiAppts" style="font-size:26px;font-weight:800;margin-top:6px">0</div></div>
          <div class="card"><div class="mut">Nuevos clientes</div><div id="kpiClients" style="font-size:26px;font-weight:800;margin-top:6px">0</div></div>
          <div class="card"><div class="mut">Retención</div><div id="kpiRetention" style="font-size:26px;font-weight:800;margin-top:6px">0%</div></div>
        </div>
      </div>
      <div class="card" data-id="leads"><div class="drag-handle">↕ Leads</div><h2>Fuentes de leads</h2><canvas id="chartLeads"></canvas></div>
      <div class="card" data-id="services"><div class="drag-handle">↕ Servicios</div><h2>Servicios (ranking)</h2><canvas id="chartServices"></canvas></div>
      <div class="card" data-id="funnel"><div class="drag-handle">↕ Embudo</div><h2>Embudo</h2><svg id="funnel"></svg></div>
    </div>
  </section>

  <!-- CLIENTES -->
  <section id="tab-clientes" class="tab" style="display:none">
    <div class="card">
      <h2>Clientes</h2>
      <div class="toolbar">
        <input id="cliSearch" placeholder="Buscar por nombre, email o teléfono" />
        <button id="btnNewClient" class="btn primary">+ Nuevo cliente</button>
      </div>
      <table>
        <thead><tr><th>Nombre</th><th>Teléfono</th><th>Email</th><th>Vehículo</th><th></th></tr></thead>
        <tbody id="clientsTbody"><tr><td colspan="5" class="mut">Cargando…</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- AGENDA -->
  <section id="tab-agenda" class="tab" style="display:none">
    <div class="card">
      <h2>Agenda semanal</h2>
      <div class="toolbar">
        <button class="btn" id="btnPrev">◀︎ Semana</button>
        <button class="btn" id="btnToday">Hoy</button>
        <button class="btn" id="btnNext">Semana ▶︎</button>
        <input id="gcalId" placeholder="tu-cal@group.calendar.google.com" style="min-width:280px"/>
        <button class="btn" id="btnSync">Actualizar GCal</button>
        <button class="btn primary" id="btnNewAppt">+ Nueva cita</button>
        <span id="rangeLabel" class="mut"></span>
      </div>
      <div class="week" id="weekGrid">
        <div class="hours" id="hours"></div>
        <div class="daycol" data-day="1"></div>
        <div class="daycol" data-day="2"></div>
        <div class="daycol" data-day="3"></div>
        <div class="daycol" data-day="4"></div>
        <div class="daycol" data-day="5"></div>
        <div class="daycol" data-day="6"></div>
        <div class="daycol" data-day="7"></div>
      </div>
    </div>
  </section>

  <!-- MARKETING -->
  <section id="tab-marketing" class="tab" style="display:none">
    <div class="grid" id="mktGrid" data-grid="mkt">
      <div class="card" data-id="leadsTbl">
        <div class="drag-handle">↕ Leads</div>
        <h2>Leads</h2>
        <div class="toolbar">
          <button id="btnNewLead" class="btn primary">+ Nuevo lead</button>
        </div>
        <table>
          <thead><tr><th>Fecha</th><th>Cliente</th><th>Fuente</th><th>Estado</th><th></th></tr></thead>
          <tbody id="leadsTbody"><tr><td colspan="5" class="mut">Cargando…</td></tr></tbody>
        </table>
      </div>
      <div class="card" data-id="campTbl">
        <div class="drag-handle">↕ Campañas</div>
        <h2>Campañas</h2>
        <div class="toolbar">
          <button id="btnNewCamp" class="btn primary">+ Nueva campaña</button>
        </div>
        <table>
          <thead><tr><th>Nombre</th><th>Canal</th><th>Presupuesto</th><th>Conversiones</th><th></th></tr></thead>
          <tbody id="campTbody"><tr><td colspan="5" class="mut">Cargando…</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- AJUSTES -->
  <section id="tab-ajustes" class="tab" style="display:none">
    <div class="card">
      <h2>Ajustes</h2>
      <div class="grid">
        <div class="card">
          <h3>Google Calendar</h3>
          <label>Calendar ID</label><input id="setCalendarId" placeholder="tu-cal@group.calendar.google.com" />
          <label><input type="checkbox" id="setCreateGCal"/> Crear evento en Google al guardar cita</label>
          <div class="toolbar"><button id="btnSaveSettings" class="btn primary">Guardar ajustes</button></div>
          <small class="mut">Para crear en Google, configura `/api/calendar-create` con OAuth y variables en Vercel.</small>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- MODALES -->
<div class="modalBack" id="modalClient">
  <div class="modal">
    <h3 id="cliTitle">Cliente</h3>
    <label>Nombre</label><input id="cliName" />
    <label>Teléfono</label><input id="cliPhone" />
    <label>Email</label><input id="cliEmail" type="email" />
    <div class="row">
      <div><label>Marca</label><input id="cliBrand" placeholder="Toyota"/></div>
      <div><label>Modelo</label><input id="cliModel" placeholder="Corolla"/></div>
    </div>
    <div class="row">
      <div><label>Año</label><input id="cliYear" type="number" placeholder="2022"/></div>
      <div><label>Color</label><input id="cliColor" placeholder="Negro"/></div>
    </div>
    <label>Notas</label><textarea id="cliNotes" rows="3"></textarea>
    <div class="toolbar" style="justify-content:flex-end">
      <button class="btn" id="cliCancel">Cancelar</button>
      <button class="btn primary" id="cliSave">Guardar</button>
    </div>
  </div>
</div>

<div class="modalBack" id="modalAppt">
  <div class="modal">
    <h3 id="apptTitle">Cita</h3>
    <label>Cliente</label>
    <select id="apptClient"></select>
    <div class="row">
      <div><label>Servicio</label>
        <select id="apptService"><option>Interior</option><option>Tratamiento Cerámico</option><option>Motor a Vapor</option><option>Paquete Completo</option></select>
      </div>
      <div><label>Fecha</label><input id="apptDate" type="date"/></div>
    </div>
    <div class="row">
      <div><label>Inicio</label><input id="apptStart" type="time"/></div>
      <div><label>Fin</label><input id="apptEnd" type="time"/></div>
    </div>
    <label>Notas</label><textarea id="apptNotes" rows="3"></textarea>
    <div class="toolbar" style="justify-content:flex-end">
      <button class="btn" id="apptCancel">Cancelar</button>
      <button class="btn primary" id="apptSave">Guardar</button>
    </div>
  </div>
</div>

<div class="modalBack" id="modalLead">
  <div class="modal">
    <h3 id="leadTitle">Lead</h3>
    <label>Cliente (opcional)</label><input id="leadClient" placeholder="Nombre del contacto"/>
    <div class="row">
      <div><label>Fuente</label><select id="leadSource"><option>Instagram</option><option>Facebook</option><option>Web</option><option>WhatsApp</option><option>Referido</option></select></div>
      <div><label>Estado</label><select id="leadStatus"><option>Nuevo</option><option>Contactado</option><option>Calificado</option><option>Ganado</option><option>Perdido</option></select></div>
    </div>
    <label>Notas</label><textarea id="leadNotes" rows="3"></textarea>
    <div class="toolbar" style="justify-content:flex-end">
      <button class="btn" id="leadCancel">Cancelar</button>
      <button class="btn primary" id="leadSave">Guardar</button>
    </div>
  </div>
</div>

<div class="modalBack" id="modalCamp">
  <div class="modal">
    <h3 id="campTitle">Campaña</h3>
    <label>Nombre</label><input id="campName" />
    <div class="row">
      <div><label>Canal</label><input id="campChannel" placeholder="Instagram / Google Ads / etc."/></div>
      <div><label>Presupuesto</label><input id="campBudget" type="number" step="0.01" /></div>
    </div>
    <label>Conversiones</label><input id="campConv" type="number" />
    <div class="toolbar" style="justify-content:flex-end">
      <button class="btn" id="campCancel">Cancelar</button>
      <button class="btn primary" id="campSave">Guardar</button>
    </div>
  </div>
</div>

<script type="module">
  import { supabase } from "./supabaseClient.js";
  import "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";

  // ===== Tema
  const root=document.documentElement;
  root.setAttribute('data-theme', localStorage.getItem('md_theme')||'dark');
  document.getElementById('btnTheme').onclick=()=>{ const n=root.getAttribute('data-theme')==='dark'?'light':'dark'; root.setAttribute('data-theme',n); localStorage.setItem('md_theme',n); };

  // ===== Auth guard
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) location.href = "./index.html";
  supabase.auth.onAuthStateChange((_e,s)=>{ if(!s) location.href="./index.html"; });
  document.getElementById("btnSignOut").onclick = async ()=> { await supabase.auth.signOut(); };

  // ===== Tabs
  document.querySelectorAll('.tabbtn').forEach(b=>{
    b.onclick=()=>{
      document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(x=>x.style.display='none');
      b.classList.add('active'); document.getElementById('tab-'+b.dataset.tab).style.display='block';
    }
  });

  // ===== Util
  const fmtARS = n => new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(n||0);
  const show = (el,flag)=> el.style.display = flag?'flex':'none';
  const q = sel => document.querySelector(sel);

  // ===== Drag & drop grid
  const enableDnD = (gridEl, key) => {
    let dragEl = null;
    const persist=()=> localStorage.setItem('layout_'+key, JSON.stringify([...gridEl.children].map(c=>c.dataset.id)));
    gridEl.querySelectorAll('.card').forEach(card=>{
      const h = card.querySelector('.drag-handle') || card.firstElementChild;
      if(!h) return; h.draggable=true;
      h.addEventListener('dragstart', e=>{ dragEl=card; card.style.opacity=.5; });
      h.addEventListener('dragend',   e=>{ card.style.opacity=''; dragEl=null; persist(); });
    });
    gridEl.addEventListener('dragover', e=>{ e.preventDefault(); const after=[...gridEl.children].find(c=> e.clientY <= c.getBoundingClientRect().top + c.offsetHeight/2 ); gridEl.insertBefore(dragEl, after||null); });
    const saved = localStorage.getItem('layout_'+key);
    if(saved){ const ids=JSON.parse(saved); const map={}; [...gridEl.children].forEach(c=>map[c.dataset.id]=c); ids.forEach(id=> map[id] && gridEl.appendChild(map[id])); }
  };
  enableDnD(q('#dashGrid'),'dash'); enableDnD(q('#mktGrid'),'mkt');

  // ===== Charts (se alimentan luego con datos reales si querés)
  const chartLeads = new Chart(q('#chartLeads'), { type:'doughnut', data:{ labels:['Instagram','Facebook','Web','WhatsApp','Referido'], datasets:[{ data:[40,25,20,10,5] }]}, options:{responsive:true, maintainAspectRatio:false}});
  const chartServices = new Chart(q('#chartServices'), { type:'bar', data:{ labels:['Interior','Cerámico','Motor','Paquete'], datasets:[{ data:[72,48,34,28], backgroundColor:'#0a8d4b'}]}, options:{responsive:true, maintainAspectRatio:false}});

  // ======= CLIENTES (CRUD)
  const clientsTbody = q('#clientsTbody');
  let clients = []; let editingClientId = null;
  async function loadClients(filter=''){
    const sel = filter? `or(name.ilike.%${filter}%,email.ilike.%${filter}%,phone.ilike.%${filter}%)` : '*';
    const { data, error } = await supabase.from('clients').select('*').order('created_at',{ascending:false});
    clients = data||[];
    renderClients(filter);
  }
  function renderClients(filter=''){
    const f = filter.toLowerCase();
    const rows = clients.filter(c => !f || (c.name||'').toLowerCase().includes(f) || (c.email||'').toLowerCase().includes(f) || (c.phone||'').toLowerCase().includes(f))
      .map(c=>{
        const v = c.vehicle||{};
        return `<tr>
          <td>${c.name||''}</td>
          <td>${c.phone||''}</td>
          <td>${c.email||''}</td>
          <td>${[v.brand,v.model,v.year,v.color].filter(Boolean).join(' / ')}</td>
          <td style="text-align:right">
            <button class="btn" data-ed="${c.id}">Editar</button>
            <button class="btn" data-del="${c.id}">Borrar</button>
          </td>
        </tr>`; }).join('') || `<tr><td colspan="5" class="mut">Sin clientes</td></tr>`;
    clientsTbody.innerHTML = rows;
  }
  q('#cliSearch').addEventListener('input', e=> renderClients(e.target.value));
  q('#btnNewClient').onclick=()=> openClientModal({});
  clientsTbody.addEventListener('click', async (e)=>{
    const id = e.target.dataset.ed || e.target.dataset.del;
    if(!id) return;
    if(e.target.dataset.ed){ const c = clients.find(x=>x.id===id); openClientModal(c); }
    if(e.target.dataset.del){ if(confirm('¿Borrar cliente?')){ await supabase.from('clients').delete().eq('id', id); loadClients(); } }
  });

  // Modal cliente
  const mCli = q('#modalClient'); const cliFields = {
    name:q('#cliName'), phone:q('#cliPhone'), email:q('#cliEmail'),
    brand:q('#cliBrand'), model:q('#cliModel'), year:q('#cliYear'), color:q('#cliColor'),
    notes:q('#cliNotes')
  };
  function openClientModal(c){
    editingClientId = c.id || null;
    q('#cliTitle').textContent = editingClientId?'Editar cliente':'Nuevo cliente';
    cliFields.name.value = c.name||''; cliFields.phone.value=c.phone||''; cliFields.email.value=c.email||'';
    const v = c.vehicle||{}; cliFields.brand.value=v.brand||''; cliFields.model.value=v.model||''; cliFields.year.value=v.year||''; cliFields.color.value=v.color||'';
    cliFields.notes.value = c.notes||'';
    show(mCli,true);
  }
  q('#cliCancel').onclick=()=> show(mCli,false);
  q('#cliSave').onclick= async ()=>{
    const row = {
      name: cliFields.name.value.trim(),
      phone: cliFields.phone.value.trim(),
      email: cliFields.email.value.trim(),
      vehicle: { brand:cliFields.brand.value.trim(), model:cliFields.model.value.trim(), year:cliFields.year.value.trim(), color:cliFields.color.value.trim() },
      notes: cliFields.notes.value.trim()
    };
    if(editingClientId) await supabase.from('clients').update(row).eq('id', editingClientId);
    else await supabase.from('clients').insert(row);
    show(mCli,false); loadClients(q('#cliSearch').value);
  };

  // ======= AGENDA (CRUD + lectura GCal)
  // grid temporal
  const hoursCol = q('#hours'); for(let i=0;i<24;i++){ const d=document.createElement('div'); d.className='mut'; d.textContent=(i<10?'0':'')+i+':00'; hoursCol.appendChild(d); }
  const dayCols = [...document.querySelectorAll('.daycol')];
  function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()||7); x.setDate(x.getDate()-day+1); x.setHours(0,0,0,0); return x; }
  let weekStart = startOfWeek(new Date());
  const label = q('#rangeLabel'); const gcalInput = q('#gcalId'); gcalInput.value = localStorage.getItem('gcal_id')||'';
  function renderWeek(){
    label.textContent = weekStart.toLocaleDateString('es-AR',{day:'2-digit',month:'short'}) + ' — ' + new Date(weekStart.getTime()+6*864e5).toLocaleDateString('es-AR',{day:'2-digit',month:'short'});
    dayCols.forEach(col=>{ col.innerHTML=''; for(let r=0;r<24;r++){ const s=document.createElement('div'); s.className='slot'; col.appendChild(s); }});
  }
  q('#btnPrev').onclick=()=>{ weekStart.setDate(weekStart.getDate()-7); renderWeek(); paintAppointments(); };
  q('#btnNext').onclick=()=>{ weekStart.setDate(weekStart.getDate()+7); renderWeek(); paintAppointments(); };
  q('#btnToday').onclick=()=>{ weekStart=startOfWeek(new Date()); renderWeek(); paintAppointments(); };
  q('#btnSync').onclick=()=>{ localStorage.setItem('gcal_id', gcalInput.value.trim()); syncCalendar(); };
  renderWeek();

  function eventPlacement(startISO, endISO){
    const start = new Date(startISO); const end = new Date(endISO);
    const dow = (start.getDay()||7); const rowStart = start.getHours()+1; const rowSpan = Math.max(1, Math.ceil((end-start)/3600000));
    return {dow,rowStart,rowSpan,start};
  }
  function paintEvent({dow,rowStart,rowSpan,start}, title, meta={}){
    const col = dayCols[dow-1]; if(!col) return;
    const e = document.createElement('div'); e.className='event'; e.style.gridRow = `${rowStart} / span ${rowSpan}`;
    e.textContent = `${title} (${start.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'})})`;
    e.dataset.meta = JSON.stringify(meta);
    e.onclick = ()=> openApptModal(meta);
    col.appendChild(e);
  }

  async function syncCalendar(){
    const calendarId = (gcalInput.value||'').trim(); if(!calendarId){ alert('Ingresá Calendar ID'); return; }
    const timeMin = new Date(weekStart).toISOString(); const timeMax = new Date(weekStart.getTime()+7*864e5).toISOString();
    const res = await fetch(`/api/calendar?calendarId=${encodeURIComponent(calendarId)}&timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}`);
    const json = await res.json();
    renderWeek();
    (json.items||[]).forEach(ev=>{
      const startISO = ev.start.dateTime || ev.start.date; const endISO = ev.end?.dateTime || ev.end?.date || startISO;
      paintEvent(eventPlacement(startISO,endISO), ev.summary||'Evento', { source:'gcal', title:ev.summary||'', startISO, endISO });
    });
    await paintAppointments();
  }

  async function paintAppointments(){
    const min = new Date(weekStart); const max = new Date(weekStart.getTime()+7*864e5);
    const { data } = await supabase.from('appointments').select('id, client_id, service, day, start, "end", notes, clients(name)').gte('created_at', min.toISOString()).lte('created_at', max.toISOString()).order('day');
    (data||[]).forEach(r=>{
      const startISO = new Date(weekStart.getTime() + (r.day-1)*864e5).toISOString().slice(0,10) + 'T' + r.start;
      const endISO   = new Date(weekStart.getTime() + (r.day-1)*864e5).toISOString().slice(0,10) + 'T' + r.end;
      const title = `${r.service} — ${r.clients?.name||'Cliente'}`;
      paintEvent(eventPlacement(startISO,endISO), title, { source:'supa', supaId:r.id, client_id:r.client_id, service:r.service, date:startISO.slice(0,10), start:r.start, end:r.end, notes:r.notes||'' });
    });
  }

  // Modal cita
  const mAppt = q('#modalAppt'); let editingApptId = null;
  const apptFields = { client:q('#apptClient'), service:q('#apptService'), date:q('#apptDate'), start:q('#apptStart'), end:q('#apptEnd'), notes:q('#apptNotes') };
  async function loadClientOptions(){
    const { data } = await supabase.from('clients').select('id,name').order('name');
    apptFields.client.innerHTML = (data||[]).map(c=> `<option value="${c.id}">${c.name}</option>`).join('');
  }
  function openApptModal(meta={}){
    editingApptId = meta.supaId || null;
    q('#apptTitle').textContent = editingApptId?'Editar cita':'Nueva cita';
    loadClientOptions().then(()=>{
      if(meta.client_id) apptFields.client.value = meta.client_id;
    });
    apptFields.service.value = meta.service || 'Interior';
    apptFields.date.value    = meta.date    || new Date().toISOString().slice(0,10);
    apptFields.start.value   = meta.start   || '10:00';
    apptFields.end.value     = meta.end     || '11:00';
    apptFields.notes.value   = meta.notes   || '';
    show(mAppt,true);
  }
  q('#btnNewAppt').onclick=()=> openApptModal({});
  q('#apptCancel').onclick=()=> show(mAppt,false);
  q('#apptSave').onclick= async ()=>{
    const day = (new Date(apptFields.date.value)).getDay() || 7;
    const row = { client_id: apptFields.client.value, service: apptFields.service.value, day, start: apptFields.start.value, end: apptFields.end.value, notes: apptFields.notes.value };
    let res;
    if(editingApptId) res = await supabase.from('appointments').update(row).eq('id', editingApptId).select().single();
    else res = await supabase.from('appointments').insert(row).select().single();
    if(res.error){ alert('Error: '+res.error.message); return; }

    // crear también en Google si está habilitado
    const createG = JSON.parse(localStorage.getItem('setCreateGCal')||'false');
    const calId = localStorage.getItem('setCalendarId') || gcalInput.value;
    if(createG && calId){
      const startISO = `${apptFields.date.value}T${apptFields.start.value}`;
      const endISO   = `${apptFields.date.value}T${apptFields.end.value}`;
      await fetch('/api/calendar-create',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ calendarId: calId, summary: `${row.service}`, description: apptFields.notes.value, startISO, endISO }) }).catch(()=>{});
    }

    show(mAppt,false); renderWeek(); paintAppointments();
  };

  // ======= LEADS (CRUD)
  const leadsTbody = q('#leadsTbody'); let leads=[];
  async function loadLeads(){ const { data } = await supabase.from('leads').select('*').order('created_at',{ascending:false}); leads=data||[]; renderLeads(); }
  function renderLeads(){
    leadsTbody.innerHTML = leads.map(l=>`<tr>
      <td>${new Date(l.created_at).toLocaleDateString('es-AR')}</td>
      <td>${l.client_name||'—'}</td>
      <td>${l.source||'—'}</td>
      <td>
        <select data-upd="${l.id}">
          ${['Nuevo','Contactado','Calificado','Ganado','Perdido'].map(s=>`<option ${l.status===s?'selected':''}>${s}</option>`).join('')}
        </select>
      </td>
      <td style="text-align:right"><button class="btn" data-del="${l.id}">Borrar</button></td>
    </tr>`).join('') || `<tr><td colspan="5" class="mut">Sin leads</td></tr>`;
  }
  q('#btnNewLead').onclick=()=>{ q('#leadTitle').textContent='Nuevo lead'; q('#leadClient').value=''; q('#leadSource').value='Instagram'; q('#leadStatus').value='Nuevo'; q('#leadNotes').value=''; show(q('#modalLead'),true); };
  q('#leadCancel').onclick=()=> show(q('#modalLead'),false);
  q('#leadSave').onclick= async ()=>{
    const row = { client_name:q('#leadClient').value.trim(), source:q('#leadSource').value, status:q('#leadStatus').value, notes:q('#leadNotes').value };
    await supabase.from('leads').insert(row); show(q('#modalLead'),false); loadLeads(); refreshLeadCharts();
  };
  leadsTbody.addEventListener('change', async (e)=>{ const id=e.target.dataset.upd; if(!id) return; await supabase.from('leads').update({status:e.target.value}).eq('id',id); refreshLeadCharts(); });
  leadsTbody.addEventListener('click', async (e)=>{ const id=e.target.dataset.del; if(!id) return; if(confirm('¿Borrar lead?')){ await supabase.from('leads').delete().eq('id',id); loadLeads(); refreshLeadCharts(); }});

  function refreshLeadCharts(){
    const agg = leads.reduce((m,l)=> (m[l.source]= (m[l.source]||0)+1, m), {});
    chartLeads.data.labels = Object.keys(agg); chartLeads.data.datasets[0].data = Object.values(agg); chartLeads.update();
  }

  // ======= CAMPAÑAS (CRUD)
  const campTbody = q('#campTbody'); let campaigns=[];
  async function loadCampaigns(){ const { data } = await supabase.from('campaigns').select('*').order('created_at',{ascending:false}); campaigns=data||[]; renderCampaigns(); refreshCampChart(); }
  function renderCampaigns(){
    campTbody.innerHTML = campaigns.map(c=>`<tr>
      <td>${c.name||''}</td>
      <td>${c.channel||''}</td>
      <td>${fmtARS(c.budget||0)}</td>
      <td>${c.conversions||0}</td>
      <td style="text-align:right">
        <button class="btn" data-ed="${c.id}">Editar</button>
        <button class="btn" data-del="${c.id}">Borrar</button>
      </td>
    </tr>`).join('') || `<tr><td colspan="5" class="mut">Sin campañas</td></tr>`;
  }
  q('#btnNewCamp').onclick=()=>{ openCampModal({}); };
  campTbody.addEventListener('click', async (e)=>{
    const id = e.target.dataset.ed || e.target.dataset.del; if(!id) return;
    if(e.target.dataset.ed){ const c=campaigns.find(x=>x.id===id); openCampModal(c); }
    if(e.target.dataset.del){ if(confirm('¿Borrar campaña?')){ await supabase.from('campaigns').delete().eq('id',id); loadCampaigns(); refreshCampChart(); } }
  });

  const mCamp=q('#modalCamp'); let editingCampId=null;
  function openCampModal(c){ editingCampId=c.id||null; q('#campTitle').textContent = editingCampId?'Editar campaña':'Nueva campaña';
    q('#campName').value=c.name||''; q('#campChannel').value=c.channel||''; q('#campBudget').value=c.budget||''; q('#campConv').value=c.conversions||0;
    show(mCamp,true);
  }
  q('#campCancel').onclick=()=> show(mCamp,false);
  q('#campSave').onclick= async ()=>{
    const row = { name:q('#campName').value.trim(), channel:q('#campChannel').value.trim(), budget: +q('#campBudget').value||0, conversions: +q('#campConv').value||0 };
    if(editingCampId) await supabase.from('campaigns').update(row).eq('id',editingCampId);
    else await supabase.from('campaigns').insert(row);
    show(mCamp,false); loadCampaigns(); refreshCampChart();
  }
  function refreshCampChart(){
    const agg = campaigns.reduce((m,c)=> (m[c.name]=c.conversions||0, m), {});
    const el = document.getElementById('chartServices'); // reutilizo bar
    // (si querés gráfico separado, crea otro canvas)
  }

  // ======= Ajustes
  const setCalendarId = q('#setCalendarId'); const setCreateGCal = q('#setCreateGCal');
  function loadSettings(){
    setCalendarId.value = localStorage.getItem('setCalendarId') || (localStorage.getItem('gcal_id')||'');
    setCreateGCal.checked = JSON.parse(localStorage.getItem('setCreateGCal')||'false');
  }
  loadSettings();
  q('#btnSaveSettings').onclick=()=>{ localStorage.setItem('setCalendarId', setCalendarId.value.trim()); localStorage.setItem('setCreateGCal', JSON.stringify(setCreateGCal.checked)); alert('Ajustes guardados'); };

  // ======= Inicializa data
  loadClients(); loadLeads().then(refreshLeadCharts); loadCampaigns(); paintAppointments();

  // Embudo simple
  (function funnel(){
    const f=document.getElementById('funnel'); const w=f.clientWidth||300, h=260; f.setAttribute('viewBox',`0 0 ${w} ${h}`);
    const rows=[[w*1.0,70,'Visitas'],[w*.75,70,'Oportunidades'],[w*.5,70,'Clientes']]; let y=10;
    rows.forEach(([bw,bh,label],i)=>{ const x=(w-bw)/2;
      const p=document.createElementNS('http://www.w3.org/2000/svg','rect'); p.setAttribute('x',x); p.setAttribute('y',y); p.setAttribute('rx','10'); p.setAttribute('width',bw); p.setAttribute('height',bh);
      p.setAttribute('fill', i? (i===1?'#1f2937':'#495') : '#0a8d4b'); f.appendChild(p);
      const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',w/2); t.setAttribute('y',y+bh/2+5); t.setAttribute('text-anchor','middle'); t.setAttribute('fill','#e8eef2'); t.textContent=label; f.appendChild(t);
      y+=bh+12;
    });
  })();
</script>
</body>
</html>
