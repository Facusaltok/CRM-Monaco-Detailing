<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monaco Detailing CRM ‚Äî Dashboard</title>

  <!-- Supabase GLOBAL -->
  <script src="https://unpkg.com/@supabase/supabase-js@2" crossorigin="anonymous"></script>
  <script>
    window.supabaseClient = window.supabase.createClient(
      "https://nqokfvddbpjqrsfflntk.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xb2tmdmRkYnBqcXJzZmZsbnRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NDE5OTgsImV4cCI6MjA3MTIxNzk5OH0.A5CzSNjHJ9y012vJjDunzYMTzoxGwu6RV88OmKYOUGo"
    );
  </script>

  <!-- Tailwind y Alpine -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{ brand:"#0a8d4b", brand2:"#19c37d", border:"#e5e7eb", textmut:"#5b677a" },
          boxShadow:{ card:"0 12px 24px rgba(20,30,40,.06)", btn:"0 6px 0 #e3e8ef, 0 14px 24px rgba(10,20,30,.08), inset 0 1px 0 rgba(255,255,255,.7)" },
          borderRadius:{ xl2:"14px" }
        }
      }
    }
  </script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <style>
    body{ background:#f6f8fb; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 12px 24px rgba(20,30,40,.06) }
    .btn{ border:1px solid #d9e1ea; background:#fff; color:#0b1220; font-weight:700; border-radius:12px; padding:.6rem .9rem; box-shadow:0 6px 0 #e3e8ef, 0 14px 24px rgba(10,20,30,.08), inset 0 1px 0 rgba(255,255,255,.7) }
    .btn:hover{ background:#f7fafc }
    .btn-primary{ background:linear-gradient(90deg,#0a8d4b,#19c37d); color:#062015; border-color:#16a86a }
    .pill{ display:inline-flex; align-items:center; border-radius:999px; padding:.2rem .55rem; font-size:.75rem; font-weight:700 }
    .input, select, textarea{ border:1px solid #d1d5db; border-radius:.6rem; padding:.55rem .7rem; width:100% }
    .input:focus, select:focus, textarea:focus{ outline:none; border-color:#19c37d; box-shadow:0 0 0 3px rgba(25,195,125,.20) }
    [x-cloak]{ display:none!important }
  </style>
</head>

<body x-data="crm()" x-init="init()">

  <!-- Topbar -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-border">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-3.5 h-3.5 rounded-full" style="background:linear-gradient(90deg,#0a8d4b,#19c37d)"></div>
        <h1 class="font-extrabold tracking-wide">MONACO DETAILING ‚Äî CRM</h1>
      </div>
      <div class="flex gap-2">
        <button class="btn" @click="loadAll()">‚ü≥ Actualizar</button>
        <button class="btn" @click="logout()">Salir</button>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="bg-white border-b border-border">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap gap-2">
      <button class="btn" :class="{'btn-primary':tab==='home'}" @click="tab='home'">Dashboard</button>
      <button class="btn" :class="{'btn-primary':tab==='clientes'}" @click="tab='clientes'">Clientes</button>
      <button class="btn" :class="{'btn-primary':tab==='citas'}" @click="tab='citas'">Citas</button>
      <button class="btn" :class="{'btn-primary':tab==='vehiculos'}" @click="tab='vehiculos'">Veh√≠culos</button>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">

    <!-- DASHBOARD -->
    <section x-show="tab==='home'" x-cloak>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-emerald-100 text-brand flex items-center justify-center">üë•</div>
          <div><div class="text-sm text-textmut">Clientes</div><div class="text-2xl font-extrabold" x-text="stats.clientes"></div></div>
        </div>
        <div class="card p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-emerald-100 text-brand flex items-center justify-center">üóìÔ∏è</div>
          <div><div class="text-sm text-textmut">Citas hoy</div><div class="text-2xl font-extrabold" x-text="stats.citasHoy"></div></div>
        </div>
        <div class="card p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-emerald-100 text-brand flex items-center justify-center">$</div>
          <div><div class="text-sm text-textmut">Ingresos hoy</div><div class="text-2xl font-extrabold" x-text="fmtARS(stats.ingresosHoy)"></div></div>
        </div>
        <div class="card p-5 flex items-center gap-4">
          <div class="w-12 h-12 rounded-lg bg-emerald-100 text-brand flex items-center justify-center">üöó</div>
          <div><div class="text-sm text-textmut">Veh√≠culos</div><div class="text-2xl font-extrabold" x-text="stats.vehiculos"></div></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
        <div class="card p-5">
          <h2 class="font-bold text-brand mb-3">Agenda ‚Äî Google Calendar</h2>
          <div class="aspect-[4/3] w-full border border-border rounded-xl overflow-hidden bg-white">
            <iframe class="w-full h-full" frameborder="0" scrolling="no"
              src="https://calendar.google.com/calendar/embed?src=monacodetailingarg%40gmail.com&ctz=America%2FArgentina%2FBuenos_Aires"></iframe>
          </div>
          <p class="text-sm text-textmut mt-2">Vista del calendario (solo lectura).</p>
        </div>

        <div class="card p-5">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-bold text-brand">Citas del d√≠a</h2>
            <button class="btn" @click="openCita()">+ Nueva cita</button>
          </div>
          <ul class="divide-y">
            <template x-for="a in citasHoy()" :key="a.id">
              <li class="py-3 flex items-center justify-between">
                <div>
                  <div class="font-semibold" x-text="a.cliente_nombre || 'Cliente'"></div>
                  <div class="text-sm text-textmut" x-text="a.servicio + ' ‚Äî ' + fmtARS(a.precio || 0)"></div>
                </div>
                <div class="flex items-center gap-2">
                  <span class="pill" :class="statusPill(a.estado)" x-text="a.estado"></span>
                  <button class="btn" @click="openCita(a)">Editar</button>
                </div>
              </li>
            </template>
            <li x-show="citas.length===0" class="text-center py-6 text-textmut">Sin citas cargadas</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section x-show="tab==='clientes'" x-cloak>
      <div class="card p-5">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
          <h2 class="font-bold text-brand text-lg">Clientes</h2>
          <div class="flex gap-2 w-full md:w-auto">
            <input class="input w-full md:w-72" placeholder="Buscar‚Ä¶" x-model="filtros.clientQ">
            <button class="btn btn-primary" @click="openCliente()">+ Nuevo cliente</button>
          </div>
        </div>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full table text-sm">
            <thead><tr class="text-left border-b"><th class="py-2 px-3">Nombre</th><th class="py-2 px-3">Email</th><th class="py-2 px-3">Tel√©fono</th><th class="py-2 px-3">Acciones</th></tr></thead>
            <tbody>
              <template x-for="c in clientesFiltrados()" :key="c.id">
                <tr class="border-b hover:bg-slate-50">
                  <td class="py-2 px-3" x-text="c.nombre"></td>
                  <td class="py-2 px-3" x-text="c.email || '‚Äî'"></td>
                  <td class="py-2 px-3" x-text="c.telefono || '‚Äî'"></td>
                  <td class="py-2 px-3">
                    <button class="btn" @click="openCliente(c)">Editar</button>
                    <button class="btn" @click="delCliente(c.id)">Eliminar</button>
                  </td>
                </tr>
              </template>
              <tr x-show="clientes.length===0"><td colspan="4" class="py-6 text-center text-textmut">Sin clientes</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CITAS -->
    <section x-show="tab==='citas'" x-cloak>
      <div class="card p-5">
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3">
          <h2 class="font-bold text-brand text-lg">Citas</h2>
          <div class="flex gap-2 w-full md:w-auto">
            <input class="input w-44" type="date" x-model="filtros.citaFecha">
            <select class="input w-44" x-model="filtros.citaEstado">
              <option value="">Todos</option>
              <option value="pendiente">Pendiente</option>
              <option value="completado">Completado</option>
              <option value="cancelado">Cancelado</option>
            </select>
            <button class="btn btn-primary" @click="openCita()">+ Nueva cita</button>
          </div>
        </div>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead><tr class="text-left border-b"><th class="py-2 px-3">Cliente</th><th class="py-2 px-3">Servicio</th><th class="py-2 px-3">Fecha/Hora</th><th class="py-2 px-3">Precio</th><th class="py-2 px-3">Estado</th><th class="py-2 px-3">Acciones</th></tr></thead>
            <tbody>
              <template x-for="a in citasFiltradas()" :key="a.id">
                <tr class="border-b hover:bg-slate-50">
                  <td class="py-2 px-3" x-text="a.cliente_nombre"></td>
                  <td class="py-2 px-3" x-text="a.servicio"></td>
                  <td class="py-2 px-3" x-text="fmtDateTime(a.fecha)"></td>
                  <td class="py-2 px-3" x-text="fmtARS(a.precio || 0)"></td>
                  <td class="py-2 px-3">
                    <span class="pill" :class="statusPill(a.estado)" x-text="a.estado"></span>
                  </td>
                  <td class="py-2 px-3">
                    <button class="btn" @click="openCita(a)">Editar</button>
                    <button class="btn" @click="delCita(a.id)">Eliminar</button>
                  </td>
                </tr>
              </template>
              <tr x-show="citas.length===0"><td colspan="6" class="py-6 text-center text-textmut">Sin citas</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- VEH√çCULOS -->
    <section x-show="tab==='vehiculos'" x-cloak>
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="font-bold text-brand text-lg">Veh√≠culos</h2>
          <button class="btn btn-primary" @click="openVehiculo()">+ Nuevo veh√≠culo</button>
        </div>
        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead><tr class="text-left border-b"><th class="py-2 px-3">Cliente</th><th class="py-2 px-3">Marca/Modelo</th><th class="py-2 px-3">Patente</th><th class="py-2 px-3">Acciones</th></tr></thead>
          <tbody>
            <template x-for="v in vehiculos" :key="v.id">
              <tr class="border-b hover:bg-slate-50">
                <td class="py-2 px-3" x-text="v.cliente_nombre || '‚Äî'"></td>
                <td class="py-2 px-3" x-text="v.marca + ' ' + (v.modelo || '')"></td>
                <td class="py-2 px-3" x-text="v.dominio || '‚Äî'"></td>
                <td class="py-2 px-3">
                  <button class="btn" @click="openVehiculo(v)">Editar</button>
                  <button class="btn" @click="delVehiculo(v.id)">Eliminar</button>
                </td>
              </tr>
            </template>
            <tr x-show="vehiculos.length===0"><td colspan="4" class="py-6 text-center text-textmut">Sin veh√≠culos</td></tr>
          </tbody>
          </table>
        </div>
      </div>
    </section>

  </main>

  <!-- MODALES -->
  <div x-show="modal.cliente" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" x-transition.opacity>
    <div class="card w-full max-w-lg p-5">
      <h3 class="font-bold text-brand mb-3" x-text="clienteForm.id ? 'Editar cliente' : 'Nuevo cliente'"></h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input class="input" placeholder="Nombre" x-model="clienteForm.nombre">
        <input class="input" placeholder="Email" x-model="clienteForm.email" type="email">
        <input class="input" placeholder="Tel√©fono" x-model="clienteForm.telefono">
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button class="btn" @click="modal.cliente=false">Cancelar</button>
        <button class="btn btn-primary" @click="saveCliente()">Guardar</button>
      </div>
    </div>
  </div>

  <div x-show="modal.cita" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" x-transition.opacity>
    <div class="card w-full max-w-lg p-5">
      <h3 class="font-bold text-brand mb-3" x-text="citaForm.id ? 'Editar cita' : 'Nueva cita'"></h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <select class="input" x-model="citaForm.cliente_id">
          <option value="">Cliente‚Ä¶</option>
          <template x-for="c in clientes" :key="c.id"><option :value="c.id" x-text="c.nombre"></option></template>
        </select>
        <input class="input" placeholder="Servicio" x-model="citaForm.servicio">
        <input class="input" type="datetime-local" x-model="citaForm.fecha">
        <input class="input" type="number" min="0" step="1" placeholder="Precio (ARS)" x-model="citaForm.precio">
        <select class="input" x-model="citaForm.estado">
          <option value="pendiente">Pendiente</option>
          <option value="completado">Completado</option>
          <option value="cancelado">Cancelado</option>
        </select>
        <textarea class="input md:col-span-2" rows="3" placeholder="Notas" x-model="citaForm.notas"></textarea>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button class="btn" @click="modal.cita=false">Cancelar</button>
        <button class="btn btn-primary" @click="saveCita()">Guardar</button>
      </div>
    </div>
  </div>

  <div x-show="modal.vehiculo" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" x-transition.opacity>
    <div class="card w-full max-w-lg p-5">
      <h3 class="font-bold text-brand mb-3" x-text="vehiculoForm.id ? 'Editar veh√≠culo' : 'Nuevo veh√≠culo'"></h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <select class="input" x-model="vehiculoForm.cliente_id">
          <option value="">Cliente‚Ä¶</option>
          <template x-for="c in clientes" :key="c.id"><option :value="c.id" x-text="c.nombre"></option></template>
        </select>
        <input class="input" placeholder="Marca" x-model="vehiculoForm.marca">
        <input class="input" placeholder="Modelo" x-model="vehiculoForm.modelo">
        <input class="input" placeholder="Patente" x-model="vehiculoForm.dominio">
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button class="btn" @click="modal.vehiculo=false">Cancelar</button>
        <button class="btn btn-primary" @click="saveVehiculo()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- L√ìGICA -->
  <script>
    const supabase = window.supabaseClient;

    window.crm = function(){
      return {
        tab:'home',
        clientes:[], vehiculos:[], citas:[],
        modal:{cliente:false,cita:false,vehiculo:false},
        clienteForm:{id:null,nombre:'',email:'',telefono:''},
        citaForm:{id:null,cliente_id:'',servicio:'',fecha:'',precio:'',estado:'pendiente',notas:''},
        vehiculoForm:{id:null,cliente_id:'',marca:'',modelo:'',dominio:''},
        filtros:{clientQ:'',citaFecha:'',citaEstado:''},
        stats:{clientes:0,citasHoy:0,ingresosHoy:0,vehiculos:0},

        fmtARS(n){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS',maximumFractionDigits:0}).format(+n||0) },
        fmtDateTime(iso){ if(!iso) return ''; const d=new Date(iso); return d.toLocaleString('es-AR',{weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}); },
        statusPill(s){ return {'bg-emerald-100 text-emerald-700':s==='completado','bg-yellow-100 text-yellow-700':s==='pendiente','bg-red-100 text-red-700':s==='cancelado'}; },

        async init(){
          const { data:{ session } } = await supabase.auth.getSession();
          if(!session){ location.href='./index.html'; return; }
          await this.loadAll();
        },
        async loadAll(){ await Promise.all([this.loadClientes(),this.loadVehiculos(),this.loadCitas()]); this.recalc(); },
        async logout(){ await supabase.auth.signOut(); location.href='./index.html'; },

        // Clientes
        async loadClientes(){ const { data } = await supabase.from('clientes').select('*').order('creado_en',{ascending:false}); this.clientes=data||[]; },
        openCliente(c){ this.clienteForm = c ? JSON.parse(JSON.stringify(c)) : {id:null,nombre:'',email:'',telefono:''}; this.modal.cliente=true; },
        async saveCliente(){ const r={nombre:this.clienteForm.nombre,email:this.clienteForm.email,telefono:this.clienteForm.telefono}; if(this.clienteForm.id) await supabase.from('clientes').update(r).eq('id',this.clienteForm.id); else await supabase.from('clientes').insert(r); this.modal.cliente=false; await this.loadClientes(); this.recalc(); },
        async delCliente(id){ if(!confirm('¬øEliminar cliente?')) return; await supabase.from('clientes').delete().eq('id',id); await this.loadClientes(); this.recalc(); },
        clientesFiltrados(){ const q=(this.filtros.clientQ||'').toLowerCase(); if(!q) return this.clientes; return this.clientes.filter(c=> (c.nombre||'').toLowerCase().includes(q)||(c.email||'').toLowerCase().includes(q)||(c.telefono||'').toLowerCase().includes(q)); },

        // Veh√≠culos
        async loadVehiculos(){ const { data } = await supabase.from('vehiculos').select('*, clientes(nombre)').order('creado_en',{ascending:false}); this.vehiculos=(data||[]).map(v=>({...v,cliente_nombre:v.clientes?.nombre||''})); },
        openVehiculo(v){ this.vehiculoForm = v ? {id:v.id,cliente_id:v.cliente_id,marca:v.marca,modelo:v.modelo,dominio:v.dominio} : {id:null,cliente_id:'',marca:'',modelo:'',dominio:''}; this.modal.vehiculo=true; },
        async saveVehiculo(){ const r={cliente_id:this.vehiculoForm.cliente_id||null,marca:this.vehiculoForm.marca,modelo:this.vehiculoForm.modelo,dominio:this.vehiculoForm.dominio}; if(this.vehiculoForm.id) await supabase.from('vehiculos').update(r).eq('id',this.vehiculoForm.id); else await supabase.from('vehiculos').insert(r); this.modal.vehiculo=false; await this.loadVehiculos(); this.recalc(); },
        async delVehiculo(id){ if(!confirm('¬øEliminar veh√≠culo?')) return; await supabase.from('vehiculos').delete().eq('id',id); await this.loadVehiculos(); this.recalc(); },

        // Citas
        async loadCitas(){ const { data } = await supabase.from('citas').select('*, clientes(nombre)').order('fecha',{ascending:false}); this.citas=(data||[]).map(a=>({...a,cliente_nombre:a.clientes?.nombre||''})); },
        openCita(a){ this.citaForm = a ? {id:a.id,cliente_id:a.cliente_id,servicio:a.servicio,fecha:a.fecha?.slice(0,16),precio:a.precio||'',estado:a.estado||'pendiente',notas:a.notas||''} : {id:null,cliente_id:'',servicio:'',fecha:new Date().toISOString().slice(0,16),precio:'',estado:'pendiente',notas:''}; this.modal.cita=true; },
        async saveCita(){ const f=this.citaForm.fecha?new Date(this.citaForm.fecha):null; const r={cliente_id:this.citaForm.cliente_id||null,servicio:this.citaForm.servicio,fecha:f?f.toISOString():null,precio:+this.citaForm.precio||0,estado:this.citaForm.estado,notas:this.citaForm.notas}; if(this.citaForm.id) await supabase.from('citas').update(r).eq('id',this.citaForm.id); else await supabase.from('citas').insert(r); this.modal.cita=false; await this.loadCitas(); this.recalc(); },
        async delCita(id){ if(!confirm('¬øEliminar cita?')) return; await supabase.from('citas').delete().eq('id',id); await this.loadCitas(); this.recalc(); },
        citasFiltradas(){ let arr=this.citas.slice(); if(this.filtros.citaFecha){ const d=this.filtros.citaFecha; arr=arr.filter(x=>(x.fecha||'').slice(0,10)===d);} if(this.filtros.citaEstado) arr=arr.filter(x=>(x.estado||'')===this.filtros.citaEstado); return arr; },
        citasHoy(){ const t=new Date().toISOString().slice(0,10); return this.citas.filter(x=>(x.fecha||'').slice(0,10)===t); },

        // KPIs
        recalc(){ this.stats.clientes=this.clientes.length; this.stats.vehiculos=this.vehiculos.length; const hoy=this.citasHoy(); this.stats.citasHoy=hoy.length; this.stats.ingresosHoy=hoy.filter(x=>x.estado==='completado').reduce((a,b)=>a+(+b.precio||0),0); }
      }
    }
  </script>
</body>
</html>
